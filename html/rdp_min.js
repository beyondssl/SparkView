var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(k,C,z){k!=Array.prototype&&k!=Object.prototype&&(k[C]=z.value)};$jscomp.getGlobal=function(k){return"undefined"!=typeof window&&window===k?k:"undefined"!=typeof global&&null!=global?global:k};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(k,C,z,Q){if(C){z=$jscomp.global;k=k.split(".");for(Q=0;Q<k.length-1;Q++){var S=k[Q];S in z||(z[S]={});z=z[S]}k=k[k.length-1];Q=z[k];C=C(Q);C!=Q&&null!=C&&$jscomp.defineProperty(z,k,{configurable:!0,writable:!0,value:C})}};$jscomp.polyfill("Array.prototype.fill",function(k){return k?k:function(k,z,Q){var C=this.length||0;0>z&&(z=Math.max(0,C+z));if(null==Q||Q>C)Q=C;Q=Number(Q);0>Q&&(Q=Math.max(0,C+Q));for(z=Number(z||0);z<Q;z++)this[z]=k;return this}},"es6-impl","es3");
$jscomp.checkStringArgs=function(k,C,z){if(null==k)throw new TypeError("The 'this' value for String.prototype."+z+" must not be null or undefined");if(C instanceof RegExp)throw new TypeError("First argument to String.prototype."+z+" must not be a regular expression");return k+""};
$jscomp.polyfill("String.prototype.startsWith",function(k){return k?k:function(k,z){var C=$jscomp.checkStringArgs(this,k,"startsWith");k+="";for(var S=C.length,W=k.length,M=Math.max(0,Math.min(z|0,C.length)),ba=0;ba<W&&M<S;)if(C[M++]!=k[ba++])return!1;return ba>=W}},"es6-impl","es3");var svManager={getInstance:function(){var k=window.$rdp;return k&&k.running&&k.running()?k:null}};svGlobal.getInstance=svManager.getInstance;
function connvertServer(k){var C={};C.id=k.id;C.server=k.id;C.displayName=k.displayName||k.id;if(k=k.rdp){for(var z in k)C[z]=k[z];C.user=k.username||"";C.pwd=k.password||"";C.useConsole=k.console||!1;C.legacyMode=k.leagacyMode||k.legacyMode||!1;C.server_bpp=k.color||16;C.exe=k.remoteProgram||"";C.args=k.remoteArgs||"";C.startProgram=0<C.exe.length?"app":C.command&&0<C.command.length?"shell":"noapp"}return C}
function Rdp2(k){k=svGlobal.util.getServerArgs(k);if(!k||!k.gateway)return hi5.notifications.notify({msg:__svi18n.noauth}),null;var C=k.gateway||"",z=0,Q=0,S=16,W=1==k.useSSL||"true"==k.useSSL||"on"==k.useSSL||null;k.width&&(z=parseInt(k.width,10));k.height&&(Q=parseInt(k.height,10));k.color&&(S=parseInt(k.color,10));k.server_bpp&&(S=parseInt(k.server_bpp,10));k=hi5.browser.obj2url(k);null===W&&(W="https:"==location.protocol);return new Rdp((W?"wss://":"ws://")+C+"/RDP?"+k,z,Q,S)}
svGlobal.Rdp2||(svGlobal.Rdp2=Rdp2);
function Rdp(k,C,z,Q){var S,W;function M(a){return"on"==a||"true"==a||1==a}function ba(){var a=d.gateway;d.ongetgatewayaddress&&(a=d.ongetgatewayaddress(a));return a}function Gb(){var a=hi5.storage.get("SV_CONN_SHARE_ID");a||(a=hi5.tool.uuid(),hi5.storage.set("SV_CONN_SHARE_ID",a));return a}function ua(){return h.displayName||h.server||h.symlink||h.id||"undefined"}function Ka(a,b,c){d.ontitlechange&&(a=d.ontitlechange(a,c));d.setTitle&&a&&(b=b||window,b.document.title=a)}function va(a,b){switch(a){case 16:case 8:case 24:case 32:break;
case 15:return h.invitation||d.showMessage("15 bit color is not supported anymore."),!1;default:return!1}ra=a;b&&(I?I.postMessage({type:0,cmd:1,data:a}):E&&E.setColor(a));return!0}function pa(a,b,c,f){H=a;B=b;La=Ma=0;Na=H-1;Oa=B-1;U&&(H=(h.waWidth||hi5.browser.getScreenWidth())|0,B=(h.waHeight||hi5.browser.getScreenHeight())|0);h.minWidth&&H<h.minWidth&&(H=h.minWidth|0);h.minHeight&&B<h.minHeight&&(B=h.minHeight|0);H&=-4;B&=-4;svGlobal.logger.warn("resolution changed, w:"+H+" h:"+B);var e=H,q=B;x?
x.resize(e,q):x=new eb(e,q);t.setSize(H,B,U?"hidden":null);if(c||H!=a||B!=b)I?I.postMessage({type:0,cmd:2,data:{w:H,h:B}}):E&&E.setResolution(H,B);if(d.onresolutionchange&&!f)d.onresolutionchange(a,b)}function A(a){!ca&&F&&(I?(Pa.data=a,"string"!=typeof a?I.postMessage(Pa,[a]):I.postMessage(Pa)):E.writeRawInput(a))}function fb(a){switch(a){case "\r":break;case "\n":d.writeScancode(28);break;case "\t":d.writeScancode(15);break;default:A("86"+a)}}function Qa(a){if(d){var b=__svi18n.errorCode[a];d.displayMsg&&
b&&d.showMessage(b);0<svGlobal.log&&console.error&&console.error(b||"error code: "+a);if(d.onerror)d.onerror({name:a,message:b})}}function Ra(a){if(d){var b=__svi18n.info[a];b||(b="info "+a);d.displayMsg&&d.showMessage(b);svGlobal.logger.info(b)}}function Sa(){var a=F;qa=F=!1;I?I.postMessage({type:0,cmd:3}):E&&E.resetStatus();a&&(F=a)}function Hb(){var a=t.getFocused(),a=a?a.getWindow():window;return"&waWidth="+h.waWidth+"&waHeight="+h.waHeight+"&dpWidth="+a.innerWidth+"&dpHeight="+a.innerHeight}
function Ta(a){J||(J=new hi5.file.UploadManager(new hi5.file.WsFileService(A)),J.addEvent("beforeupload",function(a,c,f){if(d.beforeupload)return d.beforeupload(a,c,f)}),J.addEvent("fileuploaded",function(a,c,f){if(d.onfileuploaded)d.onfileuploaded(a,c,f)}),J.addEvent("uploaded",function(a,c){if(d.onuploaded)d.onuploaded(a,c)}),J.addEvent("uploadingCancelled",function(){if(d.onuploadingCancelled)d.onuploadingCancelled()}));a.setFileHandler(J)}function gb(a,b,c){var f=!1;this.exe=a;this.args=b||"";
this._dir=c||"";var e=this;this.close=function(){!f&&F&&(f=!0,A("8C5"+e.exe+"\t"+e.args+"\t"+d.sessionInfo.appInfo.session))}}function Ua(a){var b=this;a||(a=143);this.send=function(c){var f=!!c.buffer,e=f?c:c.getData(),d=64==a;c=f?e.length:c.getEnd()||e.length;c<e.length&&(e=f?e.subarray(0,c):e.slice(0,c));f=d?5:9;c=new Uint8Array(f+c);c[0]=a;if(d)c[1]=b.id,c[2]=b.id>>8,c[3]=b.id>>16,c[4]=b.id>>24;else for(var d=b.name,g=Math.min(d.length,8),y=0;y<g;y++)c[1+y]=d.charCodeAt(y);c.set(e,f);A(c.buffer)};
this.name="";this.count=this.id=this.flags=0}function Ib(){var a=window.opener;if(a)try{if(a.__sparkUser&&a.__sparkUser.session)return a.__sparkUser;if(a.opener&&a.opener.__sparkUser.session)return a.opener.__sparkUser}catch(b){}return null}function Jb(){var a=0,b=0,c=new d.GatewayChannel;c.name="MESSGSTB";c.onopen=function(){svGlobal.logger.info("Message Channel open")};c.process=function(f){if(0==f.getByte())f.getByte(),f.getByte(),f.getByte();else{var e=f.getByte(),q=f.getLittleEndian16(),g=f.getLittleEndian16();
if(0!=e)svGlobal.logger.warn("Invalid AUTODETECT_REQUEST");else switch(g){case 1:case 4097:g=new RdpBuffer(new Uint8Array(6),0,6);g.setByte(6);g.setByte(1);g.setLittleEndian16(q);g.setLittleEndian16(0);g.markEnd();c.send(g);break;case 20:case 276:case 4116:a=6;b=Date.now();break;case 2:q=f.getLittleEndian16();a+=q;break;case 43:case 1065:case 1577:43==g&&(e=f.getLittleEndian16(),a=a+e+8,f.skipPosition(e));f=f.has(4)?f.getLittleEndian32():0;a+=f;f=Date.now()-b;e=new RdpBuffer(new Uint8Array(14),0,
14);e.setByte(14);e.setByte(1);e.setLittleEndian16(q);e.setLittleEndian16(43==g?3:11);e.setLittleEndian32(f);e.setLittleEndian32(a);e.markEnd();c.send(e);break;case 2112:case 2176:case 2240:q=f.getLittleEndian32();g=f.getLittleEndian32();f=f.getLittleEndian32();Ea={baseRTT:q,bandwidth:g,averageRTT:f};if(d.onnetworkresult)d.onnetworkresult(Ea);svGlobal.logger.warn("Network Characteristics Result:");svGlobal.logger.warn(Ea);break;default:svGlobal.logger.warn("Invalid network detect PDU",f)}}};c.onclose=
function(){svGlobal.logger.info("MSG channel close")};d.addGatewayChannel(c)}function Kb(a,b){var c=document.createElement("div"),f=document.createElement("input");f.type="radio";f.name="ds_name";f.value=a;0==a&&(f.defaultChecked=!0);c.appendChild(f);c.innerHTML+=b;c.innerHTML+="<br>";return c}function hb(){var a="";h&&M(h.connectif)&&h.symlink&&"sessionStorage"in window&&(a="SV_"+h.symlink,h.domain&&(a+=h.domain),h.user&&(a+=h.user));return a}function Lb(){var a=hb(),b="";a&&(b=sessionStorage[a]||
"")&&(b="&preSymJoin="+b);return b}function Mb(a,b){var c=0,f=t.size(),e=Array(f),q=Array(f),g=0,y=0,k=0,Z=0,r=0,m=0,u="";if(a){q=x.parseMonitorDef(a);for(f=q.length;c<f;c++){var l=q[c];l[0]<k&&(k=l[0]);l[1]<Z&&(Z=l[1]);l[2]>r&&(r=l[2]);l[3]>m&&(m=l[3])}0>k&&(g=-k);0>Z&&(y=-Z);l=0>b?[k,Z,r,m]:q[b];h.width=l[2]-l[0]+1;h.height=l[3]-l[1]+1;c=t.getSurface(0);c.setMonitor(l[0],l[1],l[2],l[3]);if(g||y)for(l=c.getMousePosition(),l.left+=g,l.right+=g,l.top+=y,l.bottom+=y,c=0;c<f;c++)l=q[c],l[0]+=g,l[1]+=
y,l[2]+=g,l[3]+=y;x.setMonitorLayout(q);0>b&&x.setMonitorCount(0);d.reconnectOnResize=!1;return"&monitorDef="+a+"&width="+h.width+"&height="+h.height}if(1<f&&!U){for(t.verifyMonitors();c<f;c++)l=t.getSurface(c),l=l.getMousePosition(),l.left<k&&(k=l.left),l.top<Z&&(Z=l.top),l.right>r&&(r=l.right),l.bottom>m&&(m=l.bottom),e[c]=l,u&&(u+=","),u+=l.left+":"+l.top+":"+l.right+":"+l.bottom;0>k&&(g=-k);0>Z&&(y=-Z);for(c=0;c<f;c++){l=t.getSurface(c).getMousePosition();if(g||y)l.left+=g,l.right+=g,l.top+=y,
l.bottom+=y;q[c]=[l.left,l.top,l.right,l.bottom,l.left==g&&l.top==y?1:0]}x.setMonitorLayout(q);d.reconnectOnResize=!1}u&&(svGlobal.logger.warn("MonitorDef:"+u),h.width=r-k+1,h.height=m-Z+1,u="&monitorDef="+u+"&width="+h.width+"&height="+h.height);return u}function ib(){var a;if(!F){qa=!1;var b="";if(ca)G.init(!1,!0,!1,0,!1);else{b=k+"&width="+H+"&height="+B+"&server_bpp="+ra+"&audio="+(L.available||Va)+Lb()+Mb(h.monitorDef,h.monitor);0>k.indexOf("waWidth")&&(b+=Hb());var c=new Date;h.tzOffset||(b+=
"&tzOffset="+c.getTimezoneOffset());h.timezone||(a=hi5.DateUtils.getGMT())&&(b+="&timezone="+encodeURIComponent(a));b+="&time="+c.getTime();void 0==h.soundPref&&(h.soundPref=0,b+="&soundPref=0");var f="",e="";c="";for(c in ja)a=ja[c],"flags"in a&&(f&&(f+=",",e+=","),f+=a.name,e+=a.flags);f&&(b=b+("&channelName="+f)+("&channelFlags="+e));f="";for(c in ka)a=ka[c],"flags"in a&&(f&&(f+=","),f+=a.name);f&&(b+="&gwChannelName="+f);if(a=Ib())c=a.account,a=a.session,c&&(b+="&account="+c),a&&(b+="&session="+
a);c=hi5.browser.isTouch&&(1024<=window.innerWidth||768<=window.innerHeight);h.audioRecord=M(h.audioRecord)&&hi5.audio.recordable;G.init(c,!!h.remotefx,h.audioRecord,h.soundPref,M(h.mapCamera)&&!!navigator.mediaDevices);h.audioRecord&&(b+="&audioRecord=on");h.decompressingRDP61&&(b+="&decompressingRDP61=on");0<G.count&&(b+="&dvcChannels="+G.names.join(","));hi5.browser.binaryWS()&&(b+="&binary=on");r.existingFile&&(b+="&existingFile="+r.existingFile);b+="&isTouch="+c+"&gatewayAddr="+encodeURIComponent(ba());
b=d.modifyURL(b);r.copyTextOnly&&M(h.mapClipboard)&&(b+="&copyTextOnly=on");(c=hi5.browser.cookie.get("__SV_TOKEN_A"))&&(b+="&__SV_TOKEN_A="+encodeURIComponent(c));(c=svGlobal.Rdp.languageToKeyboard.detect())&&(b+="&_keyboard="+c);if(r.numLock||hi5.browser.isMacOS)b+="&numLock=true",h.numLock=!0;M(h.textPrinter)&&(b+="&printerDriver="+encodeURIComponent("Generic / Text Only"));k=b}void 0==r.wsPost&&(r.wsPost=!1);I?(ca&&(ca.onopen=Wa,ca.onclose=wa,ca.onmessage=function(a){Xa.data=a.data;I.postMessage(Xa,
[Xa.data])}),I.postMessage({type:0,cmd:0,data:{addr:b,width:H,height:B,server_bpp:ra,libPath:hi5.libPath,libMin:hi5.libMin,wsPost:r.wsPost}})):(E=new RdpGeneral(ca||b,H,B,ra,x,!1,r.wsPost),E.run());I?I.addEventListener("message",jb,!1):(E.onopen=Wa,E.onmessage=kb,E.onclose=wa,E.onerror=Qa,E.oninfo=Ra,E.onloggedin=Ya,E.onresolutionchange=function(a,b){pa(a,b,!1,h.monitorDef&&0<=h.monitor?!0:!1)},E.onAltSecWindows=lb,E.onMoveCursor=Za,E.onCloseSurface=mb,E.onColorChange=va,E.onHistoryReceived=function(){$a()},
E.onLockKeyState=function(a){if(d.onLockKeyState)d.onLockKeyState(a)});if(b=t.getSurface(t.size()-1))U?b&&(b.remoteApp=new gb(h.exe,h.args,"")):Ka(ua(),b.getWindow());if(h.invitation){var q=null;b&&(q=b.initChat(h.expert));xa=new d.GatewayChannel;xa.name="C_H_A_T";xa.process=function(a){a=a.getUnicodeString(a.getEnd()-a.getPosition(),!0);q&&q.add(a,h.novice)};q&&(q.onchat=function(a){if(F){var b=Array(2*a.length),b=new hi5.DataBuffer(b,0,b.length);b.setUnicodeString(a);b.markEnd();xa.send(b)}});d.addGatewayChannel(xa)}hi5.browser.isIE&&
!ya&&(0==h.playSound||0<d.mode)&&(ya=hi5.browser.loadFlash(r.flash||hi5.libPath+"plugin.swf"))&&(nb=!0)}}function jb(a){a=a.data;switch(a.type){case 1:switch(a.event){case 0:Wa();break;case 1:wa(a.expected);break;case 2:Qa(a.code);break;case 3:Ra(a.code);break;case 4:Ya();break;case 5:pa(a.w,a.h,!1,h.monitorDef&&0<=h.monitor?!0:!1);break;case 6:Za(a.x,a.y,!0);break;case 7:mb();break;case 8:0==a.id&&$a();N&&N.check(1<a.id?15555:0);break;case 9:va(a.color);break;case 10:if(d.onLockKeyState)d.onLockKeyState(a.state);
break;default:svGlobal.logger.warn("Invalid worker event "+a.type)}break;case 2:x.setRGBs(a.x,a.y,a.w,a.h,a.pixel,a.offset,a.scansize);break;case 3:x.moveArea(a.srcx,a.srcy,a.cx,a.cy,a.dx,a.dy);break;case 5:x.fillRect(a.l,a.t,a.w,a.h,a.color);break;case 6:x.drawLine(a.x1,a.y1,a.x2,a.y2,a.color);break;case 7:x.bitBlt(a.opcode,a.dstwidth,a.x,a.y,a.cx,a.cy,a.src,a.srcwidth,a.srcx,a.srcy);break;case 8:x.drawLineExt(a.x1,a.y1,a.x2,a.y2,a.color,a.opcode);break;case 9:ob(a);break;case 10:kb(a);break;case 11:T.attach(a.data,
0,a.data.length);lb(T,a.size);break;case 12:x.drawText(a.font,a.flags,a.mixmode,a.foregroundColor,a.backgroundColor,a.clipLeft,a.clipTop,a.clipcx,a.clipcy,a.boxLeft,a.boxTop,a.boxcx,a.boxcy,a.x,a.y,a.length,a.text,a._left,a._top,a._right,a._bottom);break;case 13:x.drawBitmap(a.cacheID,a.cacheIDX,a.x,a.y,a.cx,a.cy,a.srcx,a.srcy,a.opcode);break;case 14:x.saveDesktop(a.x,a.y,a.cx,a.cy,a.offset);break;case 15:x.restoreDesktop(a.x,a.y,a.cx,a.cy,a.offset);break;case 16:x.putFont(a.font,a.character,a.glyph);
break;case 17:x.putCursor(a.idx,a.cursor);break;case 18:x.setCursor(a.idx);break;case 19:x.getHistory(A,function(){I.postMessage({type:0,cmd:7})});N&&N.check(15555);break;case 20:T.attach(a.data,a.off,a.data.length-a.off);x.setHistory(a.order,T);break;case 21:x.putBitmap(a.id,a.idx,a.bitmap);break;default:svGlobal.logger.warn("Invalid worker msg "+a.type)}}function pb(a){N&&N.check(a)}function Wa(){F=!0;var a="87"+navigator.userAgent+"\t";Ga=hi5.tool.uuid();document.cookie=Ga+"=sv";A(a+Ga);if(d.onopen)d.onopen();
r.joinCloseMode&&d.setJoinCloseMode(r.joinCloseMode)}function mb(){t&&t.close()}function kb(a){var b=a.data;if("string"!=typeof b){a=new Uint8Array(b);T.attach(a,0,b.byteLength);var c=T.getLittleEndian16();switch(c){case 28:a=T;b=a.getAscllString(8);c=ka[b];null!=c?c.process(a):svGlobal.logger.warn("Channel "+b+" not found");break;case 55:a=T;switch(a.getByte()){case 0:S=a.getLittleEndian16();W=a.getLittleEndian16();ga=a.getLittleEndian32();a.skipPosition(6);la=a.getLittleEndian16();svGlobal.logger.info("Audio Format, tag="+
S+" channels="+W+" bitsPerSample="+la+" samplePerSec="+ga);qb();break;case 1:Nb(a)}N&&N.check();break;case 56:rb(T.getUnicodeString(T.getEnd()-T.getPosition(),!1));break;case 60:sb(T);break;case 62:tb(T.getUnicodeString(T.getEnd()-T.getPosition(),!1));break;case 63:ub(T);N&&N.check();break;case 64:b=T;c=b.getByte();a=b.getLittleEndian32();switch(c){case 1:b=b.getAscllString();if(G[b]&&(svGlobal.logger.info("DVC create, name:"+b+" id:"+a),G[b].newInstance?(G[a]=G[b].newInstance(),G[a].id=a):(G[b].id=
a,G[a]=G[b]),G[a].onopen))G[a].onopen();break;case 3:G[a]&&G[a].process(b);break;case 4:if(G[a]&&G[a].onclose)G[a].onclose();svGlobal.logger.info("close DVC, id:"+a)}N&&N.check();break;case 146:a:switch(a=T,b=a.getByte(),b){case 0:a=new Uint8Array(2);a[0]=146;a[1]=1;A(a.buffer);break;case 1:break;case 5:b=a.getByte();a=a.getLittleEndian32();0!=b||a&4||(da^=65536,t.execute("setFeature",[da]));break;case 6:R.remoteLockFlags=a.getLittleEndian32();R.checkLockFlags=!0;if(d.onLockKeyState)d.onLockKeyState({capsLock:0!=
(R.remoteLockFlags&4),numLock:0!=(R.remoteLockFlags&2),scrollLock:0!=(R.remoteLockFlags&1)},{capsLock:0!=(R.localLockFlags&4),numLock:0!=(R.localLockFlags&2),scrollLock:0!=(R.localLockFlags&1)});svGlobal.logger.info("remoteLockFlags: "+R.remoteLockFlags);break;case 7:b=a.getByte();d.sessionInfo.appInfo.twoFAEnabled=0<b;switch(b){case 0:b=a.getLittleEndian32();a=a.getBytes(b);d.sessionInfo.appInfo.twoFAQR=a;if(d.ontwofaqr)d.ontwofaqr(a);break;case 1:x.pause(!0,!0);if(d.ontwofacode&&d.ontwofacode())break a;
(a=t.getFocused())&&a.showTwoFACode();break;case 2:if(b=a.getByte(),a=1==a.getByte(),(!d.ontwofaresult||!d.ontwofaresult(b,a))&&R.onauthcoderesult)R.onauthcoderesult(b,a)}break;default:svGlobal.logger.warn("Invalid Client Control: "+b)}break;default:if(d.onunknownmessage)d.onunknownmessage(c,T);else svGlobal.logger.warn("@TODO:"+c+"\n")}}else switch(c=parseInt(b.substring(0,2),16),a=b.substring(2),c){case 0:A("87"+navigator.userAgent);break;case 15:if(d){ab=!1;sa=d.reconnectTimes;(d&&0==d.mode||M(h.connectif))&&
$a();c="";for(c in ja)if((b=ja[c])&&b.onopen)b.onopen();for(c in ka)if((b=ka[c])&&b.onopen)b.onopen();a&&(a=JSON.parse(a),a.capability&&d&&(d.sessionInfo.suppressOutput=!!a.capability.suppressOutput))}break;case 26:b=JSON.parse(a);if(b.name){b.name="S"+b.name;b.message||(b.message=b.msg);if(d.onnotify)d.onnotify(b);svGlobal.logger.info("msg="+a);if(2==b.type&&d.onerror)d.onerror(b);b.msg=(__svi18n.errorCode[b.name]||"")+b.msg;d.showMessage(b)}else 0<svGlobal.log&&console.erro("No error code for message:"+
a);break;case 27:t.drawLicense(a);break;case 50:if(F)switch(b=parseInt(a.substring(0,1),10),a=a.substring(1),b){case 1:Ob(a);break;case 2:za?(za.type==a?d.writeRawInput("881"+a+"\t"+za.text):d.writeRawInput("881ERROR\t"),za=null):!(b=t.getFocused())||b.processClipReq(a)||!r.clipWarnAlways&&vb||!h||h.leagacyMode||(d.showMessage(__svi18n.info.menucopy,null,5E3),vb=!0);break;case 5:(b=t.getFocused())&&"0"!=a&&b.setIgnorePaste(!0)}break;case 51:t.setReadOnly("1"==a);break;case 54:b=a.split("\t");a=ba()+
b[0];a=d.modifyURL(a);svGlobal.logger.info("Downloading file:"+a+" name:"+b[1]+" driver:"+b[2]);d.onprintingready&&d.onprintingready({link:a,printerName:b[1],pinterDriver:b[2]})||(b=t.getFocused())&&b.showPDF(a);break;case 55:b=parseInt(a.substring(0,1),16);a=a.substring(1);switch(b){case 0:a=a.split("\t");S=parseInt(a[0],10);W=parseInt(a[1],10);la=parseInt(a[2],10);ga=parseInt(a[3],10);svGlobal.logger.debug("Audio Format, tag="+S+" channels="+W+" bitsPerSample="+la+" samplePerSec="+ga);qb();break;
case 1:Pb(a)}break;case 56:rb(a);break;case 57:b=a.split("\t");svGlobal.logger.debug(a);if(a=t.getWinById(parseInt(b[0]))){if(!t.hasApp(b[1])){(c=t.getOwnerSurface(a))&&c.railWin&&(c.railWin.appId=b[1],c.railWin.addApp(b[1]));if(d.onremoteappstart)d.onremoteappstart({id:b[1]});if(a.isVisible()&&a.titleInfo&&d.ontitlechange)d.ontitlechange(c.railWin.getFullTitle(a.id),b[1])}a.appId=b[1]}break;case 58:Qb(a);break;case 59:a=hi5.Base64.dec(a,0);da=(new RdpBuffer(a,0,a.length)).getLittleEndian32();ma||
!(da&16||da&65536)?(Ha=!1,J=null):(da&16&&(Ha=!0),J||(a=t.getFocused())&&Ta(a));da&64&&d.showMessage(__svi18n.info.recording);J&&(J.setUpload(!(da&128)),J.setDownload(!(da&131072)),J.canCopyFile=0!=(da&65536));t.execute("setFeature",[da]);break;case 60:sb(b64ToBuffer(a));break;case 61:a=JSON.parse(a);switch(a.type){case 0:pa(a.width,a.height,!0,!1);va(a.color);(b=a.server)&&d&&(d.server=a.server);wb=a.length;c=t.getFocused();U=1==a.isRail;c&&(c.setAutoScale(!U),b&&Ka(ua(),c.getWindow()),b=a.keyboard,
"undefined"!=typeof b&&0==b&&c.setUnicode(!0),b=a.mapDisk)&&(Ha=!0,Ta(c));if(d.onopened)d.onopened(a);break;case 1:a=a.duration;if(d.onprogress)d.onprogress(a,wb);break;case 2:2==a.status?(Sa(),F=!0):(b=0==a.status,b==x.isPaused()||d.onsessionpause&&d.onsessionpause(b,a)||(x.pause(b),b||t.repaint(0,0,x.width-1,x.height-1),a.warn&&d.showMessage(b?__svi18n.info.sessionPaused:__svi18n.info.sessionResumed)))}break;case 62:tb(a);break;case 63:ub(b64ToBuffer(a));break;default:if(d.onunknownmessage)d.onunknownmessage(c,
a);else svGlobal.logger.warn("@TODO:"+b+"\n")}}function $a(){if(!ma&&!Y&&(Y=!0,d&&(r.pingInterval&&d.startPing(r.pingInterval),d.onready)))d.onready()}function Rb(a,b){var c=0,f=!1;this.width=a;this.interval=b;var e=0;this.start=function(){f||(f=!0,c=setInterval(function(){var b=t.getFocused();b&&F&&(b=b.getThumbnail(a))&&b.length!=e&&(A("8E7"+b),e=b.length)},b))};this.stop=function(){clearInterval(c)}}function Sb(a,b){!aa||aa.width==a&&aa.interval==b||(aa.stop(),aa=null);aa||(aa=new Rb(a,b));aa.start()}
function ub(a){var b=a.getAscllString(8);(b=ja[b])&&b.process&&b.process(a)}function tb(a){var b=parseInt(a.substring(0,1),16),c=a.substring(1);a=!1;var f=d.sessionInfo.appInfo;switch(b){case 0:var e=JSON.parse(c);Sa();F=!0;a=e.width;b=e.height;if(a==H&&b==B)break;pa(a,b,!1,!1);break;case 1:e=JSON.parse(c);d.sessionInfo.joinedSessions.push(e.numericId);f.sessions[e.numericId]=e.name||e.__ip;if(!f.joined||r.alertJoin)d.onsessionjoin&&(a=d.onsessionjoin(e)),!a&&__svi18n.info.joinsession&&d.showMessage(__svi18n.info.joinsession.applyArgs([e.numericId,
e.__ip,e.name]));break;case 2:e=JSON.parse(c);d.sessionInfo.joinedSessions.removeElm(e.numericId);delete f.sessions[e.numericId];if(!f.joined||r.alertJoin)d.onsessionexit&&(a=d.onsessionexit(e)),!a&&__svi18n.info.exitsession&&d.showMessage(__svi18n.info.exitsession.applyArgs([e.numericId,e.__ip,e.name]));break;case 3:e=JSON.parse(c);f.joinMode!=e.mode&&(f.joinMode=e.mode,b=hi5.$("joinSelect"))&&(b.value=e.mode);if(f.hasControl)break;f.hasControl=!0;t.setReadOnly(!1,2==e.mode);if(b=hi5.$("requestControl"))b.disabled=
!0;d.ongivecontrol&&(a=d.ongivecontrol());if(a)break;d.showMessage(__svi18n.info.givecontrol,null,5E3);break;case 4:e=JSON.parse(c);t.setReadOnly(!0,2==e.mode);f.hasControl=!1;if(b=hi5.$("requestControl"))b.disabled=!1;d.ontakebackcontrol&&(a=d.ontakebackcontrol());if(a)break;d.showMessage(__svi18n.info.nocontrol,null,5E3);break;case 5:e=JSON.parse(c);d.onrequirecontrol&&(a=d.onrequirecontrol(e));if(a)break;a=__svi18n.info.title.applyArgs([e.name,e.numericId,e.__ip]);b=__svi18n.info.recontrol;x.isPaused&&
(b+="<br><br>"+(__svi18n.info.autoresume||""));d.showMessage({title:a,msg:b,cbYes:function(){d.giveControl(e.numericId);this.destroy();x.isPaused()&&d.pauseSession(d.sessionInfo.appInfo.numericId,!1)},cbNo:function(){d.refuseControl(e.numericId);this.destroy()}});break;case 6:t.execute("setTouchRemoting",[!0]);break;case 7:e=JSON.parse(c);e.width&&e.height&&pa(e.width,e.height,!0,h.monitorDef&&0<=h.monitor?!0:!1);e.color&&(va(e.color,!0),svGlobal.logger.warn("Color depth changed to:"+e.color));e.version&&
(d.sessionInfo.protocolVersion=e.version);break;case 8:e=JSON.parse(c);ab=!0;if(d.onrequestcredential&&d.onrequestcredential(e,R.reconnect))break;if(d.onautherror&&d.onautherror(e,R.reconnect))break;t.getFocused().requestCredential(e,R.reconnect);break;case 9:e=JSON.parse(c);0<e.interval&&0<e.width?Sb(e.width,e.interval):aa&&(aa.stop(),aa=null);break;case 11:e=JSON.parse(c);d.onrequirejoin&&(a=d.onrequirejoin(e));if(a)break;a=__svi18n.info.title.applyArgs([e.name,e.numericId,e.__ip]);d.showMessage({title:a,
msg:__svi18n.info.reqjoin,cbYes:function(){d.allowJoin(e.numericId,!0);this.destroy()},cbNo:function(){d.allowJoin(e.numericId,!1);this.destroy()}});break;case 13:e=JSON.parse(c),"login"==e.type&&Ya()}}function sb(a){switch(a.getByte()){case 32:if(!x.isPaused()){var b=a.getLittleEndian16(),c=a.getLittleEndian16(),f=a.getLittleEndian16(),e=void 0,q=void 0;r.noCursorName||(e=a.getLittleEndian32(),d.sessionInfo.appInfo&&(q=d.sessionInfo.appInfo.sessions[e]));Za(c,f,!0,q,e,b)}}}function Za(a,b,c,f,e,
d){x.isPaused()||t.getFocused().moveCursor(a,b,c,f,e,d)}function ob(a){t.setCursor(a)}function Tb(a){var b=r.page&&r.page.join||"";if(b.startsWith("http://")||b.startsWith("https://"))return b;if(b.startsWith("/"))return location.origin+b;var c=location.href,f=c.lastIndexOf("/");if(b)return c.substring(0,f+1)+b;b=ba();c.toLowerCase().startsWith(b.toLowerCase())&&(b=c.substring(0,f));return b+"/"+a}function rb(a){a=JSON.parse(a);xb=a.session;a.server||(a.server=ua());var b=hi5.$("joinSelect");b&&(b.value=
a.joinMode);if(b=hi5.$("requestControl"))b.disabled=a.hasControl;a.joined?t.execute("setAutoScale",[!0]):(d.mode=0,M(h.connectif)&&t.setSize(H,B),r.disableJoinedAppResize&&(d.windowState=0));var c=ba(),b=Tb("join.html")+"?id="+(a.joined||a.numericId),f=a.webAddress;f&&0<f.length&&f.toLowerCase()!=c.toLowerCase()&&(c=f.indexOf("://"),d.protocol="http"==f.substring(0,c)?"ws":"wss",d.gateway=f,b+="&gateway="+encodeURIComponent(f));b=d.modifyURL(b);a.joinLink=b;d.sessionInfo.appInfo=a;"isApp"in a&&U!==
a.isApp&&(U=a.isApp,pa(H,B,!0,!0),qa||t.execute("setAutoScale",[!0]));a.ver&&a.ver!=svGlobal.version&&svGlobal.logger.warn("Client:"+svGlobal.version+" server:"+a.ver);r.cursorNameOnly=a.isAssistance;if(d.onsessionstart)d.onsessionstart(d.sessionInfo)}function Qb(a){if(J){var b=parseInt(a.charAt(0),10);a=a.substring(1);if(5==b)J.notifyFiles(JSON.parse(a));else{var c=a.split("\t");switch(b){case 1:J.confirmId(c[0],c[1],c[2]);break;case 2:J.read(c[0],parseInt(c[1],10),parseInt(c[2],10));break;case 4:J.close(c[0]);
break;case 9:a='<a href="'+d.modifyURL(ba()+c[0])+'" download="'+c[1]+'" target="_blank">'+__svi18n.info.fileReady+": "+c[1]+"</a>",__svi18n.info.download&&t.getFocused().showMessage({msg:a,title:__svi18n.info.download,cbNo:function(){J.removeFile(c[0],!0);this.destroy()},onclick:function(a){"A"==a.target.tagName&&this.destroy()}})}}}}function Pb(a){function b(a){var b=0;a*=d;for(g=0;g<d;g++)b|=(e[a+g]&255)<<8*g;b>y?(b-=k,b/=-h):b/=y;return b}if(L.available&&!x.isPaused()){var c=a.indexOf("\t"),f=
a.substring(0,c),e=hi5.Base64.dec(a,c+1);1!=S&&(ta||(ta=new MSGSM),e=ta.decode(e,0,e.length));a=la;var d=a>>3,g=0,y=Math.pow(2,a-1)-1,h=-y-1,k=Math.pow(2,a);a=0;var c=W,t=Math.floor(Math.floor(e.length/d)/c),m=L.getBuffer(t),u=m.getChannelData(0),l=m.getChannelData(1);for(a=0;a<t;){var n=2*a,P=b(n);1==c?(u[a]=P,l[a]=P):(u[a]=P,l[a]=b(n+1));a++}a=L.playBuffer(m);setTimeout(function(a){return function(){A("8A"+a)}}(f),1E3*(a-L.delay))}}function Nb(a){function b(a){return function(){A("8A"+a)}}var c=
a.getByte(),f=a.getLittleEndian16(),e=Date.now();a.skipPosition(8);a=bb(a,c,f,0);a=1E3*(a-L.delay);ma||(f+=Date.now()-e+a,setTimeout(b(c+","+f),a))}function bb(a,b,c,f){if(!nb||x.isPaused())return 0;var e=c=0,d=a.getPosition();b=a.getData();f||(f=a.getEnd()-d);var g=f;if(41222==S)return(c=L.getContext())&&c.decodeAudioData(b.buffer.slice(d),function(a){a=L.playBuffer(a);ma||setTimeout(sendLater(Ra),1E3*(a-L.delay))},function(a){svGlobal.logger.warn(a)}),0;if(e=1!=S)ta||(ta=new MSGSM),b=ta.decode(b,
d,g),d=0,g=b.length;var y=la,h=y>>3,k=Math.floor(g/h),t=a=0,m=0;e||(a=Math.pow(2,y-1)-1,t=-a-1,m=Math.pow(2,y));y=W;if(ya){d="";if(e){for(;c<g;c++)0<c&&(d+=","),d+=b[c]+","+b[c]+","+b[c]+","+b[c];ya.write(d);return f/65*.025}for(;c<g;)0<c&&(d+=","),e=b[c++]|b[c++]<<8,9>e?e=0:e>a?(e-=m,e/=-t):e/=a,d+=e,1==y&&(d+=","+e);ya.write(d);return f/h/ga*.6}f=d;d=Math.floor(k/y);g=L.getBuffer(d);h=g.getChannelData(0);k=g.getChannelData(1);c=0;if(e)for(;c<d;)1==y?k[c]=h[c]=b[f++]:(h[c]=b[f++],k[c]=b[f++]),c++;
else for(;c<d;)e=b[f++]|b[f++]<<8,e>a?(e-=m,e/=-t):e/=a,1==y?h[c]=e:(h[c]=e,e=b[f++]|b[f++]<<8,e>a?(e-=m,e/=-t):e/=a),k[c]=e,c++;return L.playBuffer(g)}function qb(){I&&I.postMessage({type:0,cmd:5,data:{tag:S,channels:W,samplePerSec:ga,bitsPerSample:la}})}function yb(a){if(!d.openLink||2E3<a.length)return!1;var b=a.indexOf(";");0<b&&(a=a.substring(b+1));b=a;a=a.toLowerCase();var c=0==a.indexOf("http://")||0==a.indexOf("https://")||0==a.indexOf("ftp://")||0==a.indexOf("mailto:")||0==a.indexOf("tel:")||
0==a.indexOf("callto:");c||(0==a.indexOf("www.")?(c=!0,a="http://"+a):0==a.indexOf("ftp.")&&(c=!0,a="ftp://"+a));if(c){if(0<a.indexOf("\r")||0<a.indexOf("\n"))return!1;if(d.onurlredirection&&d.onurlredirection(b))return!0;a=t.getFocused();if(!a)return!1;a.processLink(b);return!0}return!1}function Ub(a){if(a.startsWith("text/html;<img data-sv-img")){var b=a.indexOf('src="');if(0<b){var b=b+5,c=a.indexOf('"',b),f=a.substring(b,c),f=d.modifyURL(f);a=a.substring(0,b)+f+a.substring(c)}}return a}function Ob(a){"text/plain;"!=
a&&(1666<Date.now()-R.reqCopyTime&&(d.onservercopy&&d.onservercopy(a)||yb(a)||t.copyToClip(Ub(a))),setTimeout(function(){A("883")},999))}function Ya(){if(!qa&&(setTimeout(function(){F&&A("884")},333),d.onloggedin))d.onloggedin();cb=qa=!0;U&&t.execute("setAutoScale",[!1]);J&&(J.enabled=!0);Ia&&!U&&(x.setContext(t.getFocused().context),t.repaint(0,0,x.width-1,x.height-1))}function wa(a){if(d){hi5.browser.cookie["delete"](Ga);svGlobal.logger.warn("closed "+(d.sessionInfo.appInfo?d.sessionInfo.appInfo.numericId:
0));var b=hb();b&&d.sessionInfo.appInfo&&0==d.mode&&(sessionStorage[b]=d.sessionInfo.appInfo.session);if(d&&(b=0==d.mode,!F&&b&&Qa("connection"),b=b&&(F||sa<d.reconnectTimes)&&0<sa&&!a,Y=F=!1,b)){sa--;__svi18n.info.reconnecting&&d.showMessage(__svi18n.info.reconnecting+" "+(d.reconnectTimes-sa)+"/"+d.reconnectTimes,null,3E3);setTimeout(ib,5);svGlobal.logger.info("Reconnecting..."+sa);return}if(ab)svGlobal.logger.info("Req credential");else{N&&(d.stopPing(),N=null);I&&(I.removeEventListener("message",
jb,!1),I.postMessage({type:0,cmd:4}),I.terminate(),I=null);J&&(J.release(),J=null);O=k=null;G&&(G.close(),G=null);ja&&hi5.Arrays.release(ja);ka&&hi5.Arrays.release(ka);aa&&(aa.stop(),aa=null);L&&(L.close(),L=null);Aa=null;try{if(d.onclose)d.onclose(a);else svGlobal.logger.info("onclose: null");t&&(t.close(),t=null)}catch(c){svGlobal.logger.warn(c)}T=null;E&&(E.onopen=null,E.onmessage=null,E.onclose=null,E.onerror=null,E.close(),E=null);t=R=null;x&&(x.release(),x=null);hi5.browser.isChromeApp?chrome.runtime.onSuspend.removeListener(d.close):
window.removeEventListener("unload",d.close,!1);window&&window.$rdp==d&&(window.$rdp=null);d=null}}}function zb(){E&&F?E.close():wa(!0)}function lb(a,b){var c=a.getLittleEndian32();if(0!=(c&16777216)){var d=a.getLittleEndian32();if(0!=(c&1073741824)){a.getLittleEndian16();a.getByte();var c=a.getByte(),e=a.getLittleEndian16(),q=a.getLittleEndian16(),g=0;16>c&&(g=a.getLittleEndian16());var y=a.getLittleEndian16(),h=a.getLittleEndian16();a.getBytes(y);g&&a.getBytes(g);if(8<=c&&(g=t.getFocused())&&g.onremoteappicon){y=
new hi5.graphic.Bitmap(e,q,32);a.getPosition();for(var e=new Uint8Array(e*q*4),q=a.getPosition(),h=q+h,k,r=a.getData(),m=0,u,l;q<h;)switch(c){case 16:(k=r[q++]|r[q++]<<8)?(l=k>>7&248,u=k>>2&248,k=k<<3&248,l|=l>>5,u|=u>>5,k|=k>>5,e[m++]=k,e[m++]=u,e[m++]=l,e[m++]=255):m+=4;break;case 32:e[m++]=r[q++],e[m++]=r[q++],e[m++]=r[q++],e[m++]=r[q++]}y.putPixels(e,0,e.length);d=t.getWinById(d);g.onremoteappicon(d,y)}}else 0!=(c&2147483648)?svGlobal.logger.info("XXX rail cache icon, winId="+d):0!=(c&536870912)?
(svGlobal.logger.info("***** delete winId="+d),t.delWin(d)):Vb(a,c,d)}else if(0!=(c&33554432))svGlobal.logger.info("XXX Alt Sec window Notify="+c);else if(0!=(c&67108864))if(svGlobal.logger.info("*** -- Alt Sec window Desktop, flags:"+c),0!=(c&1))svGlobal.logger.info("Desktop non monitored flags="+c);else{if(0!=(c&32)&&(d=a.getLittleEndian32(),svGlobal.logger.info("Desktop monitored flags="+c+" winId="+d),(g=t.getOwnerSurfaceById(d))&&g.railWin&&g.railWin.setActiveWinId(d),t.setTitle(d),x.getContext()||
(d=t.getFocused())&&x.setContext(d.context),0!=(c&16)&&(d=a.getByte(),0<d)))for(c=t.zOrders,c.length=d,g=0;g<d;g++)c[g]=a.getLittleEndian32(),svGlobal.logger.info("---zorders:"+c[g])}else svGlobal.logger.info("XXX Alt Sec window order flgas="+c)}function Ab(a){var b=t.getFocused();if(b&&b.railWin){var c=a||b.railWin.mainWin;if(c&&2<c.showState&&d.windowState){var f=b.getFreeSpace();a=Math.max(Math.abs(c.winHeight-f.height),Math.abs(c.winWidth-f.width));svGlobal.logger.info("--- fitMainWin offset:"+
a+" _hOffset:"+c._hOffset+" appId:"+c.appId+" spaceH:"+f.height);0<a?(b=a==c._hOffset,c._hOffset&&b||(c._hOffset=a,setTimeout(function(){c.resize(0,0,f.width,f.height)},333))):c._hOffset=0}}}function Vb(a,b,c){U||(U=!0);var d=0==(b&268435456),e=t.getWinById(c);e?d=!0:e=new t.LocalWin(c);svGlobal.logger.info("\n\n=========== winId="+c+" existed="+d);if(e){0!=(b&2)&&(e.ownerWinid=a.getLittleEndian32(),svGlobal.logger.info("***** ownerWinid="+e.ownerWinid));0!=(b&8)&&(e.style=a.getLittleEndian32(),e.extStyle=
a.getLittleEndian32(),svGlobal.logger.info("***** winId="+c+" style="+e.style+" extStyle="+e.extStyle),svGlobal.logger.info("*****--- WS_POPUP="+(0!=(e.style&2147483648))),svGlobal.logger.info("*****--- WS_DLGFRAME="+(0!=(e.style&4194304))),svGlobal.logger.info("*****--- DS_MODALFRAME="+(0!=(e.style&128))),svGlobal.logger.info("*****--- WS_EX_DLGMODALFRAME="+(0!=(e.extStyle&1))),svGlobal.logger.info("*****--- WS_EX_TOOLWINDOW="+(0!=(e.extStyle&128))),svGlobal.logger.info("*****--- WS_BORDER="+(0!=
(e.style&8388608))),svGlobal.logger.info("*****--- WS_CAPTION="+(0!=(e.style&12582912))),svGlobal.logger.info("*****--- WS_OVERLAPPED="+(0!=(e.style&0))),svGlobal.logger.info("*****--- WS_OVERLAPPEDWINDOW="+(0!=(e.style&13565952))),svGlobal.logger.info("*****--- WS_POPUPWINDOW="+(0!=(e.style&2156396544))),svGlobal.logger.info("*****--- WS_SIZEBOX="+(0!=(e.style&262144))),svGlobal.logger.info("*****--- WS_CHILD="+(0!=(e.style&1073741824))),svGlobal.logger.info("*****--- WS_SIZEBOX="+(0!=(e.style&262144))),
svGlobal.logger.info("*****--- WS_EX_MDICHILD="+(0!=(e.extStyle&64))),svGlobal.logger.info("*****--- WS_EX_LAYERED="+(0!=(e.extStyle&524288))));0!=(b&16)&&(e.setShowState(a.getByte()),svGlobal.logger.info("***** winId="+c+" showState="+e.showState),2==e.showState&&0!=r.noMinimize&&setTimeout(function(){e.exeCommand(61728)},50));var q=0!=(b&4);if(q){var g=a.getLittleEndian16();e.titleInfo=a.getUnicodeString(g,!1);svGlobal.logger.info("***** winId="+c+" title="+e.titleInfo)}0!=(b&16384)&&(e.clientOffsetX=
a.getLittleEndian32(),e.clientOffsetY=a.getLittleEndian32(),svGlobal.logger.info("***** winId="+c+" coffX"+e.clientOffsetX+" coffY="+e.clientOffsetY));0!=(b&65536)&&(e.clientAreaWidth=a.getLittleEndian32(),e.clientAreaHeight=a.getLittleEndian32(),svGlobal.logger.info("***** winId="+c+" cw"+e.clientAreaWidth+" ch="+e.clientAreaHeight));0!=(b&131072)&&(e.rpContent=a.getLittleEndian32());0!=(b&262144)&&(e.rootParentHandle=a.getLittleEndian32());if(0!=(b&2048)){var g=a.getLittleEndian32(),y=a.getLittleEndian32();
e.winOffsetX=g;e.winOffsetY=y;svGlobal.logger.info("***** winId="+c+" offX"+e.winOffsetX+" offY="+e.winOffsetY)}0!=(b&32768)&&(e.winClientDeltaX=a.getLittleEndian32(),e.winClientDeltaY=a.getLittleEndian32(),svGlobal.logger.info("***** winId="+c+" dX"+e.winClientDeltaX+" dY="+e.winClientDeltaY));0!=(b&1024)&&(e.winWidth=a.getLittleEndian32(),e.winHeight=a.getLittleEndian32(),svGlobal.logger.info("***** winId="+c+" w"+e.winWidth+" h="+e.winHeight));if(!d)if(e.isMainWin()||3==e.showState)Ab(e);else if(2<
e.showState&&(g=t.getFocused())){var g=g.getFreeSpace(),h=e.winWidth,k=e.winHeight;if(e.winOffsetX>g.width||e.winOffsetY>g.height||0>h+e.winOffsetX||0>k+e.winOffsetY){var x=(g.width-e.winWidth)/2|0,m=(g.height-e.winHeight)/2|0;0>x&&(x=0);0>m&&(m=0);setTimeout(function(){e.resize(x,m,h,k)},50)}}0!=(b&256)&&(g=a.getLittleEndian16(),0<g&&a.skipPosition(8*g));0!=(b&4096)&&(e.visibleOffsetX=a.getLittleEndian32(),e.visibleOffsetY=a.getLittleEndian32());0!=(b&512)&&(b=a.getLittleEndian16(),e.numVisibilityRects=
b,0<b&&a.skipPosition(8*b));if(d)t.onWinChange(e);else t.addWin(e);q&&t.setTitle(c)}else svGlobal.logger.warn("XXX, No win with id:"+c)}function eb(a,b){function c(a,b,e,c,d){0<d.width?d.union(a,b,e,c):(d.x=a,d.y=b,d.width=e,d.height=c)}function d(a,b,e,c){for(F=0;F<G;F++){var p=E[F];if(a>=p[0]&&b>=p[1]&&e<=p[2]&&c<=p[3])return z[F]}return null}function e(a,b,e,g){if(G){var p=d(a,b,a+e-1,b+g-1);p&&c(a,b,e,g,p)}else c(a,b,e,g,P)}function q(a,b,e,c,d,g,l){for(var p=d*e+c,D=a.setRGB,v=a.getRGB,w=0;w<
l;w++){for(var f=0;f<g;f++){if(a){var m=v(c+f,d+w);D(c+f,d+w,~m&16777215)}else b[p]=~b[p]&16777215;p++}p+=e-g}}function g(a,b,e,c,d,g,f,m,n,u){b=u*m+n;null==f&&(f=a);for(a=0;a<g;a++){for(n=0;n<d;n++)l[c+a][e+n]=l[c+a][e+n]&f[b]&16777215|4278190080,b++;b+=m-d}}function y(a,b,e,c,d,g,l,f,m,n){b=n*f+m;m=a.setRGB;n=a.getRGB;null==l&&(l=a);for(a=0;a<g;a++){for(var p=0;p<d;p++){var v=n(e+p,c+a);m(e+p,c+a,v|l[b]&16777215);b++}b+=f-d}}function h(a,b,e,c){var d=B;if(d){var p=d.getRGB(b,e);switch(a){case 0:d.setRGB(b,
e,0);break;case 1:d.setRGB(b,e,~(p|c)&16777215);break;case 2:d.setRGB(b,e,p&~c&16777215);break;case 3:d.setRGB(b,e,~c&16777215);break;case 4:d.setRGB(b,e,16777215*(~p&c));break;case 5:d.setRGB(b,e,~p&16777215);break;case 6:d.setRGB(b,e,p^c&16777215);break;case 7:d.setRGB(b,e,~p&c&16777215);break;case 8:d.setRGB(b,e,p&c&16777215);break;case 9:d.setRGB(b,e,p^~c&16777215);break;case 10:break;case 11:d.setRGB(b,e,p|~c&16777215);break;case 12:d.setRGB(b,e,c);break;case 13:d.setRGB(b,e,(~p|c)&16777215);
break;case 14:d.setRGB(b,e,p|c&16777215);break;case 15:d.setRGB(b,e,16777215);break;default:svGlobal.logger.warn("unsupported pixel opcode: "+a),d.setRGB(b,e,c)}}}function k(a,b,e,c,d,g,l,f,m){a>f||b>m||(e=a+e-1,e>f&&(e=f),a<g&&(a=g),e=e-a+1,c=b+c-1,c>m&&(c=m),b<l&&(b=l),c=c-b+1,1>e||1>c||B.fillRect(a,b,e,c,d))}function t(a,b,e,c,d,g,f,m,n,u,q,y){if(!(b>q||e>y)){var p=b+c-1;p>q&&(p=q);n=b<n?n:b;p=p-b+1;q=e+d-1;q>y&&(q=y);u=e<u?u:e;y=q-e+1;if(!(1>p||1>y)){q=128;var D=0;f|=4278190080;m|=4278190080;
if(n==b&&u==e&&p==c&&y==d)if(0==a)for(var v=0;v<d;v++){a=e+v;for(var w=0;w<c;w++)0==q&&(D++,q=128),0!=(g[D]&q)&&(l[a][b+w]=m),q>>=1;D++;q=128;D==g.length&&(D=0)}else for(v=0;v<d;v++){a=e+v;for(w=0;w<c;w++)0==q&&(D++,q=128),l[a][b+w]=0!=(g[D]&q)?m:f,q>>=1;D++;q=128;D==g.length&&(D=0)}else if(0==a)for(v=0;v<y;v++){a=e+v;for(w=0;w<p;w++)0==q&&(D++,q=128),b+w>=n&&a>=u&&0!=(g[D]&q)&&(l[a][b+w]=m),q>>=1;D++;q=128;D==g.length&&(D=0)}else for(v=0;v<y;v++){a=e+v;for(w=0;w<p;w++)0==q&&(D++,q=128),b+w>=n&&e+
v>=u&&(l[a][b+w]=0!=(g[D]&q)?m:f),q>>=1;D++;q=128;D==g.length&&(D=0)}}}}function m(a,b,e,c,d){this.offset=a;this.baseLine=b;this.width=e;this.height=c;this.fontData=d}function u(a,b,e,c,d,g,l,f,m){this.cache_idx=a;this.rawData=b;this.none=!b;this.hotX=e;this.hotY=c;this.width=d;this.height=g;this.xorSize=f;this.andSize=m;this.result="";this.distance=0;this.bpp=l;this.system="";if(b){if(!this.distance){a=0;if(b){l=0;for(var p=b.length;l<p;l++)0!=b[l]&&(a+=l%d+(l/d|0))}this.distance=a}if(!this.system){a:switch(this.distance){case 507:a=
"text";break a;case 2046:case 4359:a="default";break a;default:a=""}this.system=a}}a="";if(!this.system&&b){l=d*g*4;a=62+l+f+m;p=new Uint8Array(a);a=new hi5.DataBuffer(p,0,a);a.setLittleEndian16(0);a.setLittleEndian16(2);a.setLittleEndian16(1);a.setByte(d);a.setByte(g);a.setByte(0);a.setByte(0);a.setLittleEndian16(e);a.setLittleEndian16(c);a.setLittleEndian32(40+l+f+m);a.setLittleEndian32(22);a.setLittleEndian32(40);a.setLittleEndian32(d);a.setLittleEndian32(2*g);a.setLittleEndian16(1);a.setLittleEndian16(32);
a.setLittleEndian32(0);a.setLittleEndian32(f+m);a.setLittleEndian32(0);a.setLittleEndian32(0);a.setLittleEndian32(0);a.setLittleEndian32(0);for(e=g-1;0<=e;e--)for(c=0;c<d;c++)g=b[d*e+c],a.setByte(g&255),a.setByte(g>>8&255),a.setByte(g>>16&255),a.setByte(g>>24&255);a="data:image/x-icon;base64,"+hi5.Base64.enc(a.getData())}this.url=a}var l=[],n=null,P=new hi5.graphic.Rectangle(0,0,0,0),V="Uint8ClampedArray"in window,K=null,x=0,C=0,Ja=0,Bb=0,A=null,E,z,F=0,G=0;this.width=a;this.height=b;var H=!1,B=this,
X={imgData:null,left:0,top:0,width:0,height:0};this.setProfiler=function(a){K=a};this.getDirtyArea=function(){return P};this.setImgRect=function(a,b,e,c){x=a;C=b;Ja=e;Bb=c};this.parseMonitorDef=function(a){var b=a.split(","),e=b.length,c=[];if(1<e){for(var d=!1,g=0;g<e;g++){var l=b[g].split(":");if(4==l.length)c[g]=Array(5),c[g][0]=parseInt(l[0]),c[g][1]=parseInt(l[1]),c[g][2]=parseInt(l[2]),c[g][3]=parseInt(l[3]),c[g][4]=0==c[g][0]&&0==c[g][1]?1:0;else{d=!0;break}}d&&(svGlobal.logger.warn("invaiid monitorDef:"+
a),c.length=0)}return c};this.setMonitorLayout=function(a){var b=a.length,e=0;E=a;for(z=Array(b);e<b;e++)z[e]=new hi5.graphic.Rectangle(0,0,0,0);G=b};this.setMonitorCount=function(a){G=a};this.addImg=function(a){Ja&&(A&&URL.revokeObjectURL(A.src),A=a)};this.flushImgs=function(){A&&(URL.revokeObjectURL(A.src),A=null,Ja=0)};this.getData=function(){return l};this.pause=function(e,c){H=e;c&&n&&n.fillRect(0,0,a,b)};this.release=function(){P=null;hi5.Arrays.release(z);B.flushImgs();l=n=B=null;X=X.imgData=
null};this.isPaused=function(){return H};this.setContext=function(e){e!=n&&(n||!e||e.createImageData(1,1).data.buffer||(V=!1),n=e,null!=n&&(X.imgData=n.createImageData(a,b)))};this.getContext=function(){return n};this.resize=function(e,c){if(l.length!=c||l[0].length!=e){for(var d=0;d<c;d++)l[d]=new Uint32Array(e);l.length=c;B.width=a=e;B.height=b=c;null!=n&&(X.imgData=n.createImageData(a,b))}};B.resize(a,b);this.getBuffer=function(){return l};this.setRGB=function(a,b,e){l[b][a]=e|4278190080};this.getRGB=
function(a,b){return l[b][a]};this.setRGBs=function(c,d,g,f,m,n,q){var p,w=c+g,v=d+f;v>b&&(v=b);if(!(c>=a)){w>a&&(g-=w-a,w=a);if(m.subarray)for(var u=d;u<v;u++,n+=q)l[u].set(m.subarray(n,n+g),c);else for(var D,u=d;u<v;u++,n+=q){var y=n;D=l[u];for(p=c;p<w;p++)D[p]=m[y++]}e(c,d,g,f)}};this.moveArea=function(a,b,c,d,g,f){if(0<f){var p=a+g,m=b+f,n,w;if(l[0].set)for(w=d-1;0<=w;w--)l[m+w].set(l[b+w].subarray(a,a+c),p);else for(w=d-1;0<=w;w--){var q=l[m+w],v=l[b+w];for(n=0;n<c;n++)q[p+n]=v[a+n]}}else if(0>
f)if(p=a+g,m=b+f,w=0,l[0].set)for(;w<d;w++)l[m+w].set(l[b+w].subarray(a,a+c),p);else for(;w<d;w++)for(q=l[m+w],v=l[b+w],n=0;n<c;n++)q[p+n]=v[a+n];else if(0<g)for(p=a+g,m=b+f,n=c-1;0<=n;n--)for(q=p+n,v=a+n,w=0;w<d;w++)l[m+w][q]=l[b+w][v];else for(p=a+g,m=b+f,n=0;n<c;n++)for(q=p+n,v=a+n,w=0;w<d;w++)l[m+w][q]=l[b+w][v];e(a+g,b+f,c,d)};this.getRGBs=function(a,b,e,c,d){var g=new Uint32Array(e*c),f=a+e;c=b+c;for(var p=0;b<c;b++)g.set(l[b].subarray(a,f),p),p+=e;d(g)};this.repaint=function(e,c,d,g){var f=
X.imgData.data,p=0,m,n;K&&K.begin("paint");0>e&&(d+=e,e=0);0>c&&(g+=c,c=0);e+d>a&&(d=a-e);c+g>b&&(g=b-c);var w=e+d;var q=c+g;if(V)for(f=new Uint32Array(f.buffer),n=c;n<q;n++)f.set(l[n].subarray(e,w),p),p+=a;else{var v=4*(a-d)|0;for(n=c;n<q;n++){for(m=e;m<w;m++){var u=l[n][m];f[p++]=u&255;f[p++]=u>>8&255;f[p++]=u>>16&255;f[p++]=255}p+=v}}X.left=e;X.top=c;X.width=d;X.height=g;K&&K.end("paint");return X};this.postPaint=e;this.draw=function(a,b,e,c){if(n&&!H)if(A&&A.complete&&(n.drawImage(A,x,C,Ja,Bb),
URL.revokeObjectURL(A.src),A=null),G){if(a=d(a,b,e,c),a.width)return B.repaint(a.x,a.y,a.width,a.height),a.width=0,X}else if(P.width)return B.repaint(P.x,P.y,P.width,P.height),P.width=0,X;return null};this.fillRect=function(a,b,c,d,g){var f=a+c,p=b+d;if(l[0].fill)for(var m,n=b;n<p;n++)l[n].fill(g,a,f);else for(n=b;n<p;n++)for(m=a;m<f;m++)l[n][m]=g;e(a,b,c,d)};this.drawLine=function(a,b,e,c,d){if(b==c){if(a>e){var g=a;a=e;e=g}var f=l[b];e++;if(f.fill)f.fill(d,a,e);else for(g=a;g<e;g++)f[g]=d}else if(a==
e)for(b>c&&(g=b,b=c,c=g),c++,g=b;g<c;g++)l[g][a]=d;else{var m=Math.abs(e-a),p=Math.abs(c-b);g=a;var f=b;e=e>=a?a=1:a=-1;b=c>=b?c=1:c=-1;if(m>=p){b=a=0;var n=m;var q=m/2|0;var w=p}else c=e=0,n=p,q=p/2|0,w=m,m=p;if(!(1>m))for(m++,p=0;p<m;p++)l[f][g]=d,q+=w,q>=n&&(q-=n,g+=a,f+=c),g+=e,f+=b}};this.bitBlt=function(a,b,c,d,f,m,n,u,h,k){var p=B;switch(a){case 0:u=p.setRGB;for(p=c;p<c+f;p++)for(h=d;h<d+m;h++)u(p,h,0);break;case 1:a=n;h=k*u+h;k=p.setRGB;b=p.getRGB;null==a&&(a=p);for(p=0;p<m;p++){for(n=0;n<
f;n++)k(c+f,d+m,~(b(c+f,d+m)|a[h])&16777215);h+=u-f}break;case 2:a=n;h=k*u+h;k=p.setRGB;b=p.getRGB;null==a&&(a=p);for(p=0;p<m;p++){for(n=0;n<f;n++){var w=b(c+f,d+m);k(c+f,d+m,w&~a[h]&16777215);h++}h+=u-f}break;case 3:q(p,n,u,h,k,f,m);n?p.setRGBs(c,d,f,m,n,k*u+h,u):p.moveArea(h,k,f,m,c-h,d-k);break;case 4:q(p,null,b,c,d,f,m);g(p,b,c,d,f,m,n,u,h,k);break;case 5:q(p,null,b,c,d,f,m);break;case 6:a=n;h=k*u+h;null==a&&(a=p);for(p=0;p<m;p++){for(k=0;k<f;k++)l[d+p][c+k]=l[d+p][c+k]^a[h]&16777215|4278190080,
h++;h+=u-f}break;case 7:a=n;h=k*u+h;k=p.setRGB;b=p.getRGB;null==a&&(a=p);for(p=0;p<m;p++){for(n=0;n<f;n++)w=b(c+n,d+p),k(c+n,d+p,~(w&a[h])&16777215),h++;h+=u-f}break;case 8:g(p,b,c,d,f,m,n,u,h,k);break;case 9:a=n;h=k*u+h;k=p.setRGB;b=p.getRGB;null==a&&(a=p);for(p=0;p<m;p++){for(n=0;n<f;n++)w=b(c+n,d+p),k(c+n,d+p,w^~a[h]&16777215),h++;h+=u-f}break;case 10:break;case 11:a=n;h=k*u+h;k=p.setRGB;b=p.getRGB;null==a&&(a=p);for(p=0;p<m;p++){for(n=0;n<f;n++)w=b(c+n,d+p),k(c+n,d+p,w|~a[h]&16777215),h++;h+=
u-f}break;case 12:n?p.setRGBs(c,d,f,m,n,k*u+h,u):p.moveArea(h,k,f,m,c-h,d-k);break;case 13:q(p,null,b,c,d,f,m);y(p,b,c,d,f,m,n,u,h,k);break;case 14:y(p,b,c,d,f,m,n,u,h,k);break;case 15:u=p.setRGB;for(p=c;p<c+f;p++)for(h=d;h<d+m;h++)u(p,h,16777215);break;default:svGlobal.logger.warn("unsupported opcode: "+a)}e(c,d,f,m)};this.drawLineExt=function(a,b,c,d,g,f){if(a==c||b==d){var m;if(b==d)if(c>a){var n=c-a;if(!(1>n))for(m=0;m<n;m++)h(f,a+m,b,g)}else{if(n=a-c,!(1>n))for(m=0;m<n;m++)h(f,c+m,b,g)}else if(d>
b){if(n=d-b,!(1>n))for(m=0;m<n;m++)h(f,a,b+m,g)}else if(n=b-d,!(1>n))for(m=0;m<n;m++)h(f,a,d+m,g)}else{var l=Math.abs(c-a),p=Math.abs(d-b);m=a;n=b;var u,q;var w=c>=a?u=1:u=-1;var k=d>=b?q=1:q=-1;if(l>=p){k=u=0;var y=l;var v=l/2>>0;var t=p}else q=w=0,y=p,v=p/2>>0,t=l,l=p;if(1>l)return;for(p=0;p<=l;p++)h(f,m,n,g),v+=t,v>=y&&(v-=y,m+=u,n+=q),m+=w,n+=k}g=Math.min(a,c);a=Math.max(a,c);c=Math.min(b,d);b=Math.max(b,d);0>a-g||0>b-c||e(g,c,a-g+1,b-c+1)};this.drawText=function(a,b,c,d,g,f,m,n,l,u,q,h,y,K,P,
r,V,Z,Fa,X,x){var p=0;1<h?k(u,q,h,y,g,Z,Fa,X,x):1==c&&k(f,m,n,l,g,Z,Fa,X,x);for(var w=r,v=0;v<r;)switch(V[p+v]){case 255:var D=V[p+v+2];if(D>w-p){v=r=0;break}D=V.slice?V.slice(p,p+D):V.subarray(p,p+D);ea[V[p+v+1]]=D;v+=3;r-=v;p=v;v=0;break;case 254:var fa=(D=ea[V[p+v+1]])?D:null;fa&&0==fa[1]&&0==(b&32)&&(0!=(b&4)?P+=V[p+v+2]:K+=V[p+v+2]);v=v+2<r?v+3:v+2;r-=v;p=v;v=0;if(!fa)break;for(var Wb=fa.length,ha=0;ha<Wb;ha++){D=Ba.getFont(a,fa[ha]);if(0==(b&32)){var A=fa[++ha];0!=(A&128)?(0!=(b&4)?P+=fa[ha+
1]|fa[ha+2]<<8:K+=fa[ha+1]|fa[ha+2]<<8,ha+=2):0!=(b&4)?P+=A:K+=A}D&&(t(c,K+D.offset&65535,P+D.baseLine&65535,D.width,D.height,D.fontData,g,d,Z,Fa,X,x),0!=(b&32)&&(K+=D.width))}break;default:D=Ba.getFont(a,V[p+v]),0==(b&32)&&(A=V[p+ ++v],0!=(A&128)?(0!=(b&4)?P+=V[p+v+1]|V[p+v+2]<<8:K+=V[p+v+1]|V[p+v+2]<<8,v+=2):0!=(b&4)?P+=A:K+=A),D&&(t(c,K+D.offset&65535,P+D.baseLine&65535,D.width,D.height,D.fontData,g,d,Z,Fa,X,x),0!=(b&32)&&(K+=D.width)),v++}1<h?0<y&&e(u,q,h,y):0<n&&0<l&&e(f,m,n,l)};this.drawBitmap=
function(b,c,e,d,g,f,m,n,l){var p=J.getBitmap(b,c);p?(b=p.width,c=p.height,g>b&&(g=b),f>c&&(f=c),12==l?B.setRGBs(e,d,g,f,p.data,n*b+m,b):B.bitBlt(l,a,e,d,g,f,p.data,b,m,n)):svGlobal.logger.warn("Failed to get bitmap from cache, id:"+b+" idx="+c)};this.saveDesktop=function(a,b,c,e,d){B.getRGBs(a,b,c,e,function(g){I.save(a,b,c,e,d,g)})};this.restoreDesktop=function(a,b,c,e,d){(d=I.restore(a,b,c,e,d))?B.setRGBs(a,b,c,e,d,0,c):svGlobal.logger.warn("XXX no matched desktop save.")};this.putFont=function(a,
b,c){Ba.putFont(a,b,c)};this.putBitmap=function(a,b,c){J.putBitmap(a,b,c)};this.putCursor=function(a,b){Ca.set(a,b)};this.setCursor=function(a){if(!H&&-1!=a){var b=Ca.get(a);if(b)B.onSetCursor(b);else svGlobal.logger.warn("invalid cursor"+a)}};var Cb=0;this.isSendingHistory=function(){return 2E3>Date.now()-Cb};this.getHistory=function(a,b){var c=null;K&&K.begin("his_bitmap");J.forEach(function(b,e,d){if(b){var g=0,f=0;d=0;for(var m=b.length;d<m;d++)b[d]&&b[d].data&&(g++,f+=b[d].raw?b[d].raw.length:
4*b[d].data.length);if(g&&f){c=new Uint8Array(f+20*g+8);c[0]=29;c[2]=1;c[3]=4;f=new hi5.DataBuffer(c,4,c.length);f.setLittleEndian32(g);for(d=0;d<m;d++)(g=b[d])&&g.data&&(f.setLittleEndian16(e),f.setLittleEndian16(d),f.setLittleEndian16(g.left),f.setLittleEndian16(g.top),f.setLittleEndian16(g.width),f.setLittleEndian16(g.height),f.setLittleEndian16(g.bitsperpixel),f.setLittleEndian16(g.codec),f.setLittleEndian32(g.raw?g.raw.length:4*g.data.length),f.setBytes(g.raw||new Uint8Array(g.data.buffer)));
a(c.buffer)}}});K&&K.end("his_bitmap");K&&K.begin("his_font");(c=Ba.toPDU())&&a(c.buffer);K&&K.end("his_font");(c=Ca.toPDU())&&a(c.buffer);for(var e=4,d=0,g=ea.length;d<g;d++)ea[d]&&(e+=ea[d].length+6);if(4<e){c=new Uint8Array(e);c[0]=29;c[2]=1;c[3]=7;for(var f=4,d=0,g=ea.length;d<g;d++)ea[d]&&ea[d].length&&(c[f++]=d,c[f++]=d>>8,e=ea[d].length,c[f++]=e,c[f++]=e>>8,c[f++]=e>>16,c[f++]=e>>24,c.set(ea[d],f),f+=e);a(c.buffer)}(c=I.toPDU())&&a(c.buffer);b();Cb=Date.now()};this.setHistory=function(a,b){switch(a){case 4:K&&
K.begin("his_bitmap_dec");for(var c=b.getLittleEndian32(),e=0;e<c;e++){var d=b.getLittleEndian16(),g=b.getLittleEndian16(),f=b.getLittleEndian16(),m=b.getLittleEndian16(),n=b.getLittleEndian16(),l=b.getLittleEndian16(),u=b.getLittleEndian16(),q=b.getLittleEndian16();var h=b.getLittleEndian32();var k=new Uint8Array(b.getData().buffer,b.getPosition(),h),y=new Uint8Array(h);y.set(k);var k=rdpcodecs.bitmap;switch(q){case 0:var v=new Uint32Array(y.buffer);b.skipPosition(h);break;case 1:switch(u){case 16:v=
k.decompressInt16(n,l,h,y,0);break;case 24:v=k.decompressInt24(n,l,h,y,0);break;case 32:v=k.decompressInt32(n,l,h,y,0)}b.skipPosition(h);break;case 2:v=new rdpcodecs.NSCodec,v.process(b,u,n,l),h=v.getData(),v=v.getDataSize(),v=new Uint32Array(v),rdpcodecs.flipimage(h,0,v,n,l,1)}J.putBitmap(d,g,new rdpcodecs.Bitmap(v,n,l,f,m,u,0==q?null:y,q))}K&&K.end("his_bitmap_dec");break;case 5:Ba.fromStream(b);break;case 6:Ca.fromStream(b);break;case 7:for(;b.has(6);)if(e=b.getLittleEndian16(),h=b.getLittleEndian32())c=
b.getData().subarray(b.getPosition(),b.getPosition()+h),ea[e]=c,b.skipPosition(h);break;case 9:I.fromStream(b)}};var Ca=new function(){var a=[],b=!1;this.useRemoteCursor=function(a){b=a};this.set=function(c,e){b&&(e.system="");a[c]=e};this.get=function(b){return a[b]};this.total=function(){return a.length};this.toPDU=function(){for(var b=2,c=2,e=0,d=0,g=a.length,f;d<g;d++)if(f=a[d])e++,c=c+7+(f.rawData?f.rawData.length:0);if(!e)return null;c=new Uint32Array(c);c[0]=100728861;c[1]=e;for(d=0;d<g;d++)if(f=
a[d])if(e=f.rawData?f.rawData.length:0,c[b++]=f.cache_idx|f.bpp<<16,c[b++]=f.hotX|f.hotY<<16,c[b++]=f.width|f.height<<16,c[b++]=f.xorSize,c[b++]=f.andSize,c[b++]=f.distance,c[b++]=e)c.set(f.rawData,b),b+=e;return c};this.fromStream=function(c){var e=c.getPosition();c=new Uint32Array(c.getData().buffer,e);for(var d=c[0],g=0,f,m,n,l,p,q,h,k,y,v,K,e=1;g<d;g++)f=c[e]&65535,m=c[e++]>>16,n=c[e]&65535,l=c[e++]>>16,p=c[e]&65535,q=c[e++]>>16,h=c[e++],k=c[e++],y=c[e++],v=c[e++],K=null,v&&(K=new Uint32Array(v),
K.set(c.subarray(e,e+v)),e+=v),m=new u(f,K,n,l,p,q,m,h,k),y&&(m.distance=y),b&&(m.system=""),a[f]=m}};Ca.useRemoteCursor(!!r.remoteCursor);var I=new function(){function a(a,b,c,e,d,g){this.x=a;this.y=b;this.cx=c;this.cy=e;this.offset=d;this.data=g}var b=[];this.save=function(c,e,d,g,f,m){c=new a(c,e,d,g,f,m);e=0;for(d=b.length;e<d;e++)if(!b[e]){b[e]=c;return}b.push(c)};this.restore=function(a,c,e,d,g){for(var f,m=0,n=b.length;m<n;m++)if((f=b[m])&&f.x==a&&f.y==c&&f.cx==e&&f.cy==d){if(f.offset==g)return a=
f.data,b[m]=null,a;svGlobal.logger.warn("TODO: offset")}return null};this.toPDU=function(){for(var a=0,c=2,e=0,d=b.length;e<d;e++)b[e]&&(a++,c+=b[e].data.length+6);if(!a||!c)return null;var c=new Uint32Array(c),g=2;c[0]=151060509;c[1]=a;for(e=0;e<d;e++)if(a=b[e])c[g++]=a.x,c[g++]=a.y,c[g++]=a.cx,c[g++]=a.cy,c[g++]=a.offset,c[g++]=a.data.length,c.set(a.data,g),g+=a.data.length;return c};this.fromStream=function(a){a=new Uint32Array(a.getData().buffer,a.getPosition());for(var b=1,c=a[0],e,d,g,f,m,n,
l,q=0;q<c;q++)e=a[b++],d=a[b++],g=a[b++],f=a[b++],m=a[b++],n=a[b++],l=new Uint32Array(n),n=b+n,l.set(a.subarray(b,n)),b=n,this.save(e,d,g,f,m,l)}},ea=[],Ba=new function(){var a=[];this.putFont=function(b,c,e){a[b]||(a[b]=[]);a[b][c]=e};this.getFont=function(b,c){return a[b]?a[b][c]:null};this.toPDU=function(){var b=0,c,e,d;var g=4;for(var f,m=a.length;b<m;b++)if((d=a[b])&&d.length)for(f=d.length,c=0;c<f;c++)(e=d[c])&&(g+=15+e.fontData.length);if(5>g)return null;var n=new Uint8Array(g);g=new hi5.DataBuffer(n,
0,g);n[0]=29;n[2]=1;n[3]=5;g.skipPosition(4);b=0;for(m=a.length;b<m;b++)if((d=a[b])&&d.length)for(f=d.length,c=0;c<f;c++)if(e=d[c])g.setByte(b),g.setLittleEndian16(c),g.setLittleEndian16(e.offset),g.setLittleEndian16(e.baseLine),g.setLittleEndian16(e.width),g.setLittleEndian16(e.height),g.setLittleEndian32(e.fontData.length),g.setBytes(e.fontData);return n};this.fromStream=function(a){for(;a.has(15);){var b=a.getByte(),c=a.getLittleEndian16(),e=a.getLittleEndian16(),d=a.getLittleEndian16(),g=a.getLittleEndian16(),
f=a.getLittleEndian16(),n=a.getLittleEndian32(),n=a.getBytes(n);this.putFont(b,c,new m(e,d,g,f,n))}}},J=new function(){var a=[],b=[];this.putBitmap=function(c,e,d){if(32767==e)b[c]&&(b[c].data=null,b[c]=null),b[c]=d;else{var g=a[c];g?g[e]&&(g[e].data=null,g[e]=null):a[c]=g=[];g[e]=d}};this.getBitmap=function(c,e){return 32767==e?b[c]:a[c]?a[c][e]:null};this.forEach=function(b){for(var c=a.length,e=0;e<c;e++)b(a[e],e,a)}}}this.displayMsg=this.reconnectOnResize=!0;this.appTimeout=1600;this.reconnectTimes=
0;this.windowState=3;this.setTitle=this.openLink=!0;this.audioBuffer=0;this.sessionInfo={domain:"",userName:"",sessionId:0,joinedSessions:[],suppressOutput:!1,appInfo:null};this.mode=0;this.remoteAppLogin=!0;var Ia=!1,ja={},ka={},xa=null,d=this,ab=!1,Y=!1,da=0,ya=null,za=null;hi5.appcfg||(hi5.appcfg={img:{},toolbar:{fadable:!0},displayMsg:!0});var r=hi5.appcfg,Ga="";this.setConfig=function(a){r=a};var ca="object"==typeof k?k:null,h=ca?{}:hi5.tool.queryToObj(k.substring(k.indexOf("?")+1)),H=0,B=0,
ra=(Q||h.color||h.server_bpp||16)|0,ta=null,Db=null,N=null,Va=hi5.browser.isIE||hi5.browser.isEdge,Ea=null;this.protocol=ca?"":k.substring(0,k.indexOf("://")).toLowerCase();this.hasSmartCard=function(){return M(h.smartCard)};this.hasScanner=function(){return M(h.scanner)};this.setProfiler=function(a){Db=a};this.getProfiler=function(){return Db};this.gateway=function(){if(ca)return"";var a=k.lastIndexOf("/RDP?");-1==a&&(a=k.lastIndexOf("/JOIN?"));-1==a&&(a=k.lastIndexOf("/PLAY?"));return k.substring(0,
a).replace(/wss\:\/\//ig,"https://").replace(/ws\:\/\//ig,"http://")}();svGlobal.logger.warn("Ver:"+svGlobal.version+" build:"+svGlobal.build);this.getGatewayAddr=ba;var ma="object"==typeof k||0<k.indexOf("/PLAY?"),Eb=!ma&&0<k.indexOf("invitation=");if(Eb){var db=decodeURIComponent(k),Da=db.indexOf(' USERNAME="');if(0<Da){var Da=Da+11,Fb=db.substring(Da,db.indexOf('"',Da));k+="&novice="+Fb+"&server="+Fb}k+="&mapClipboard=on";h.mapClipboard="on"}if(ma)this.mode=1,ca?k="":(H=640,B=480),k+="&touchpad=on",
h.touchpad="on",this.reconnectOnResize=!1;else if(0<k.indexOf("/JOIN?")||Eb)this.mode=2,this.reconnectOnResize=!1;C?H=parseInt(C):h.width&&(H=parseInt(h.width));z?B=parseInt(z):h.height&&(B=parseInt(h.height));-1==H&&(H=hi5.browser.getScreenWidth());-1==B&&(B=hi5.browser.getScreenHeight());h.symlink&&h.parameters&&hi5.tool.queryToObj(h.parameters,h);h.gateway||(k+="&gateway="+encodeURIComponent(d.gateway));!h.minWidth&&r.minWidth&&(h.minWidth=r.minWidth);!h.minHeight&&r.minHeight&&(h.minHeight=r.minHeight);
h.minWidth&&(h.minWidth=parseInt(h.minWidth));h.minHeight&&(h.minHeight=parseInt(h.minHeight));h.waWidth=h.waWidth?parseInt(h.waWidth):hi5.browser.isAndroid||hi5.browser.isiOS?Math.max(screen.width,screen.height):screen.width;h.waWidth&=-4;h.waHeight=h.waHeight?parseInt(h.waHeight):hi5.browser.isAndroid||hi5.browser.isiOS?Math.max(screen.width,screen.height):screen.height;h.waHeight&=-4;"useSSL"in h||(k+="&useSSL="+("wss"==d.protocol));hi5.storage.isAvailable&&(M(h.shareClipboard)||h.shareClipboardId)&&
(k+="&shareClipboardId="+(h.shareClipboardId||Gb()));r&&(void 0!=r.displayMsg?this.displayMsg=r.displayMsg:r.displayMsg=this.displayMsg,r.appTimeout&&(this.appTimeout=r.appTimeout),void 0!=r.reconnectOnResize&&(this.reconnectOnResize=r.reconnectOnResize),r.reconnectTimes&&(this.reconnectTimes=r.reconnectTimes),void 0!=r.windowState&&(this.windowState=r.windowState),void 0!=r.openLink&&(this.openLink=r.openLink),void 0!=r.setTitle&&(this.setTitle=r.setTitle),r.audioBuffer&&(this.audioBuffer=r.audioBuffer),
"boolean"==typeof r.useWSS&&(k=(r.useWSS?"wss":"ws")+k.substring(k.indexOf("://"))),"boolean"==typeof r.remoteAppLogin&&(this.remoteAppLogin=r.remoteAppLogin,Ia=!r.remoteAppLogin,svGlobal.logger.warn("remoteAppLogin deprecated, use hideLogin in appcfg.js instead")),"boolean"==typeof r.hideLogin&&(Ia=r.hideLogin));M(h.nocurosr);var U="app"==h.startProgram,Ha=M(h.mapDisk),na=0,J=null;U&&(this.reconnectOnResize=!1);void 0==r.useWorker&&(r.useWorker=!1);r.useWorker&&(!window.Worker||hi5.browser.isFirefox||
U&&!Va||"file:"==location.protocol||0<navigator.userAgent.indexOf("MSIE 10."))&&(r.useWorker=!1);void 0==hi5.libMin&&(hi5.libMin=!0);var I=r.useWorker?new Worker(hi5.libPath+(r.rdpworker||(hi5.libMin?"rdpworker_min.js":"rdpworker.js"))):null,sa=this.reconnectTimes,Pa=I?{type:5,data:null}:null;this.getDisplayName=ua;this.server=ua();this.port=parseInt(h.port,10);this.loadbalanceToken=r.loadbalanceTokenName?r.loadbalanceTokenName+"="+hi5.tool.uuid():"";this.modifyURL=function(a){d.loadbalanceToken&&
(a+=-1==a.indexOf("?")?"?"+d.loadbalanceToken:"&"+d.loadbalanceToken);return a};this.getURL=function(){return k};this.getColor=function(){return ra};this.changeTitle=Ka;hi5.browser.isTouch&&Math.max(H,B)>Math.max(window.innerWidth,window.innerHeight)&&(this.reconnectOnResize=!1);this.isRemoteApp=function(){return U};var E=null,F=!1,qa=!1,cb=!1,L=new function(a){var b=null;this.available=!1;this.delay=a;this.supportWebAudio=!1;if(0==h.playSound||0<d.mode)if(b=hi5.audio.getAudioContext())this.supportWebAudio=
this.available=!0;this.getContext=function(){return b};this.getBuffer=function(a){return b.createBuffer(2,a,ga)};var c=0,f=null,e=null;this.setVolume=function(a){1==a?f=null:(f||(f=b.createGain()),f.gain.value=a)};this.playBuffer=function(d){e=b.createBufferSource();e.buffer=d;f?(e.connect(f),f.connect(b.destination)):e.connect(b.destination);var g=b.currentTime,q=0<c?c:g+a;q<g&&(q=g);c=q+d.duration;e.start?e.start(q):e.noteOn(q);return c-g};this.iOSFix=function(){if(b&&hi5.browser.isSafari){var a=
this.getBuffer(1024),c=b.createBufferSource();c.buffer=a;c.connect(b.destination);c.start?c.start(0):c.noteOn(0)}};this.close=function(){b&&(f&&f.disconnect(),e&&e.disconnect(),hi5.audio.releaseAudioContext())}}(d.audioBuffer),nb=L.available,x=new eb(200,200);x.onSetCursor=ob;this.setVolume=function(a){L&&L.setVolume(a)};this.setAudioBuffer=function(a){d.audioBuffer=a;L.delay=a};var Ma=0,La=0,Na=H-1,Oa=B-1,xb="";window.$rdp||(window.$rdp=this);va(ra);this.running=function(){return F};this.setJoinMode=
function(a){F&&A("8E1"+a)};this.setJoinCloseMode=function(a){F&&A("8EB3\t"+a)};this.refuseControl=function(a){F&&A("8E3"+a)};this.giveControl=function(a){F&&A("8E4"+a)};this.pauseSession=function(a,b){F&&A("8EB"+(b?1:0)+"\t"+a)};this.closeSession=function(a){F&&A("8EB2\t"+a)};this.requestControl=function(){F&&A("8E2")};this.saveSession=function(a){F&&A("8E9"+(a.save?1:0)+"\t"+(a.timeout||0)+"\t"+(a.id||0))};this.allowJoin=function(a,b){F&&A("8EA"+a+"\t"+(b?1:0))};var Aa=new function(){function a(){if(c&&
0<c.length){var b=c.shift();b.key?Aa.sendSingleKey(b.down,b.key):b["char"]&&fb(b["char"]);0<c.length?setTimeout(a,f):(c=null,e&&e())}}var b={" ":57,space:57,pgup:201,pageup:201,pgdn:209,pagedown:209,end:207,home:199,left:203,up:200,right:205,down:208,printscreen:183,insert:210,del:211,"delete":211,altgr:184,windows:219,windowsright:220,context:221,esc:1,backspace:14,back:14,tab:15,enter:28,meta:29,command:29,ctrl:29,shift:42,alt:56,capslock:58,f1:59,f2:60,f3:61,f4:62,f5:63,f6:64,f7:65,f8:66,f9:67,
f10:68,f11:87,f12:88,numlock:69,scrolllock:70,add:78};this.sendSingleKey=function(a,c){var e=b[c.toLowerCase()];e?d.writeScancode(a,e):(e=c.length,0!=e&&(1==e?d.writeKeyCode(a,c.toUpperCase().charCodeAt(0)):a&&d.writeText(c)))};var c=null,f=0,e=null;this.sendKeyComb=function(b,d,h){if(Y){b=b.split("+");var g=b.length,q;if(0!=g){var k=null,m=[];for(q=0;q<g;q++){var u=b[q];""==u&&""==k&&(u="Add");""!=u&&m.push({key:u,down:!0});k=u}g=m.length;for(q=g-1;0<=q;q--)m.push({key:m[q].key,down:!1});if(d)c=
m,f=d,e=h,a();else for(q=0,g=m.length;q<g;q++)Aa.sendSingleKey(m[q].down,m[q].key)}}};this.sendText=function(b,d,h){for(var g=[],q=0,k=b.length;q<k;q++)g.push({"char":b.charAt(q)});c=g;f=d;e=h;a()}};this.writeKeyComb=function(a,b,c){Y&&Aa.sendKeyComb(a,b,c)};this.writeText=function(a,b,c){if(Y)if(b)Aa.sendText(a,b,c);else for(b=0,c=a.length;b<c;b++)fb(a.charAt(b))};this.writeClipboard=function(a,b){a&&(b||(b="text/plain"),d.writeRawInput("880"+b+"\t"+a.hashCode()),za={type:b,text:a})};var t=new function(a,
b){function c(){function b(a){for(;0<a.ownerWinid;){var b=k.getWinById(a.ownerWinid);if(b&&b.isVisible())a=b;else break}return a}function c(a){for(var b="";a;)a.titleInfo&&(b=a.titleInfo),a=k.getWinById(a.ownerWinid);return b}var g=[],f=[],h=0,k=this;this.mainWin=null;this.appId="";var r=0;this.getActiveWinId=function(){return r};this.setActiveWinId=function(a){svGlobal.logger.info("setActiveWinId: "+a+" old: "+r);if(r!=a){var b=0==r;r=a;(a=k.getMainByWinId(a))&&a.isMainWin()&&k.mainWin!=a&&(k.mainWin=
a);b&&(a=t.getFocused())&&(b=a.getFreeSpace(),a=b.width,d.resetSize(a,b.height))}};this.onchange=function(b){b.isVisible()||b!=k.mainWin?b.isVisible()&&!k.mainWin&&b.isMainWin()&&(k.mainWin=b,a.windowState&&b.exeCommand(61488)):k.mainWin=null};this.addWin=function(a){for(var b=g.length,c=!1,e=0;e<b;e++)if(a.id==g[e].id){g[e]=a;c=!0;break}c||g.push(a);1==g.length&&(h=Date.now());b=a.isMainWin();svGlobal.logger.info("is main win:"+b+" id:"+a.id);b&&!k.mainWin&&(k.mainWin=a)};this.popWins=function(a){a=
k.getWinById(a);var b=[];if(a){a=0<a.ownerWinid?a.ownerWinid:a.id;for(var c=g.length-1;0<=c;c--)if(g[c].ownerWinid==a||g[c].id==a)b.push(g[c]),g.splice(c,1)}return b};this.hasApp=function(a){return-1!=f.indexOf(a)};this.addApp=function(a){return-1==f.indexOf(a)?(f.push(a),!0):!1};this.isNew=function(){return 3E4>Date.now()-h};this.getAll=function(){return g};this.hasWin=function(a){return 0<=g.indexOf(a)};this.close=function(){for(var a=0,b=g.length;a<b;a++)g[a].close()};this.clear=function(){g.length=
0};this.delWin=function(a){for(var b=0,c=g.length;b<c;b++)if(g[b].id==a)return g.splice(b,1),b;return-1};this.isRunning=function(){var a=g.length;if(1>a)return!1;for(var b=0,a=g.length;b<a;b++){var c=g[b];if(c.showState)return!0}return!1};this.getWinById=function(a){var b=g.length;if(1>b)return null;for(var c=0;c<b;c++){var e=g[c];if(e.id==a)return e}return null};this.getMainWinByAppId=function(a){var b=null,c=0;for(len=g.length;c<len;){b=g[c];if(b.appId==a&&b.isVisible()&&1>b.ownerWinid)break;c++}return b};
this.getTopWin=function(a){var b=null,c,e=a.length;for(c=0;c<e&&(!(b=k.getWinById(a[c]))||!b.isVisible());c++)b=null;if(!b)for(svGlobal.logger.warn("No win found"),e=g.length,c=e-1;0<=c&&(b=g[c],!b.isVisible());c--)b=null;return b};this.getMain=function(a){return(a=k.getTopWin(a))?b(a):null};this.getMainByWinId=function(a){return(a=k.getWinById(a))?b(a):null};this.getOtherApps=function(a,e,d){var f=g.length;if(0!=f&&g[f-1])if(f=g[f-1].appId,d||!f)setTimeout(function(){k.getOtherApps(a,e)},d||3E3);
else{d=[];if(f=k.getTopWin(a)){for(var l=0<f.ownerWinid?f.ownerWinid:f.id,m=[],q=0,f=g.length;q<f;q++)g[q].ownerWinid!=l&&g[q].id!=l&&g[q].isVisible()&&m.push(g[q]);q=0;for(f=m.length;q<f;q++)m[q].ownerWinid!=l&&m[q].id!=l&&(d.push({title:c(m[q]),win:b(m[q])}),l=0<m[q].ownerWinid?m[q].ownerWinid:m[q].id)}e(d)}};this.getFullTitle=function(a){for(var b,c="";;){b=k.getWinById(a);if(!b)break;b.titleInfo&&b.isVisible()&&(c&&(c=" > "+c),c=b.titleInfo+c);if(1>a)break;a=b.ownerWinid}return c}}var f=[];this.tryCloseRemoteApps=
function(){if(a&&a.isRemoteApp())for(var b=f.length,c=0;c<b;c++)f[c].railWin&&f[c].railWin.close()};this.verifyMonitors=function(){var a=f[0].getMousePosition(),b,c=f.length;f[0].configMonitor();for(b=1;b<c;b++){f[b].configMonitor();var d=f[b].getMousePosition();Math.abs(d.left)+Math.abs(d.top)<Math.abs(a.left)+Math.abs(a.top)&&(a=d)}0!=a.left&&(a.right-=a.left,a.left=0);0!=a.top&&(a.bottom-=a.top,a.top=0);for(b=0;b<c;b++)if(d=f[b].getMousePosition(),d!=a){if(0>d.right){var h=-d.right-1;0<h&&(d.left+=
h,d.right+=h)}d.left>a.right&&(h=d.left-a.right-1,0<h&&(d.left-=h,d.right-=h));0>d.bottom&&(h=-d.bottom-1,0<h&&(d.top+=h,d.bottom+=h));d.top>a.bottom&&(h=d.top-a.bottom-1,0<h&&(d.top-=h,d.bottom-=h))}};this.repaint=function(a,b,c,d){for(var e=0,g=f.length;e<g;e++)f[e].repaint(a,b,c,d)};this.size=function(){return f.length};this.getSurface=function(a){return f[a]};this.addSurface=function(a){f.push(a)};this.hasSurface=function(a){for(var b=f.length,c=0;c<b;c++)if(f[c].equals(a))return!0;return!1};
this.fromSyncedSurface=function(a){var b=f.length;Date.now();for(var c=0;c<b;c++)if(f[c].isClipSynced(a))return!0;return!1};this.setSize=function(a,b,c){for(var e=0,d=f.length;e<d;e++)f[e].setSize(a,b,c)};this.zOrders=[];this.drawLicense=function(a){for(var b=0,c=f.length;b<c;b++)f[b].drawLicense(a)};this.setReadOnly=function(a,b){for(var c=0,e=f.length;c<e;c++)f[c].setReadOnly(a,b)};this.setVisible=function(a,b){svGlobal.logger.info("TODO: setVisible")};this.copyToClip=function(a){1>f.length||f[0].copyToClip(a)};
this.setCursor=function(a){for(var b=0,c=f.length;b<c;b++)f[b]&&f[b].setCursor(a)};this.hide=function(a){a=0;for(var b=f.length;a<b;a++)f[a]&&f[a].hide()};this.execute=function(a,b){for(var c=0,e=f.length;c<e;c++)f[c][a].apply(f[c],b)};this.addWin=function(e){var d=this.getFocused();d||(svGlobal.logger.warn("Focused surface not found!"),d=f[f.length-1]);d?(U=!0,d.railWin||(d.railWin=new c,d.onunload=function(){hi5.appcfg.closeRemoteApp&&d.railWin&&d.railWin.close();d.remoteApp&&d.remoteApp.close();
d.railWin&&(d.railWin.clear(),d.railWin=null);f.removeElm(d)}),d.context&&b.setContext(d.context),d.railWin.addWin(e),d.railWin.mainWin==e&&setTimeout(function(){var b=d.getFreeSpace();a.writeRawInput("8C661441\t"+b.width+"\t"+b.height);svGlobal.logger.info("-- main win dp change:"+b.height);a.windowState&&e.resizable()&&setTimeout(function(){e.exeCommand(61488);svGlobal.logger.info("-- max")},50)},111),Va&&d.focus()):svGlobal.logger.warn("No surface available!")};this.delWin=function(b){for(var c,
d=f.length-1;0<=d;d--){var e=f[d];c=e.railWin;var h=c.getWinById(b),k=h&&h.appId&&-1!=h.appId.toLowerCase().indexOf("runonce");if(0<=c.delWin(b)){h==c.mainWin&&(c.mainWin=null);if(e.toolbar){b="win"+b;var r=e.toolbar.querySelector("#"+b);r&&e.toolbar.removeChild(r)}if(!c.isRunning()){if(h.isMainWin()&&e.onremoteappclose)e.onremoteappclose(h);h=a.appTimeout;if(k||c.isNew())h*=10;svGlobal.logger.debug("Prepare del:"+Date.now());setTimeout(function(a){return function(){svGlobal.logger.info("Start del:"+
Date.now());a.railWin&&a.railWin.isRunning()||(a.remoteApp&&a.remoteApp.close(),t&&t.delSurface(a))}}(e),h)}}}};this.popWins=function(a){return f[0]&&f[0].railWin?f[0].railWin.popWins(a):[]};this.getWinById=function(a){for(var b,c=0,d=f.length;c<d;c++)if(f[c].railWin&&(b=f[c].railWin.getWinById(a)))return b;return null};this.getMainWinByAppId=function(a){for(var b,c=0,d=f.length;c<d;c++)if(f[c].railWin&&(b=f[c].railWin.getMainWinByAppId(a)))return b;return null};this.onWinChange=function(a){for(var b,
c=0,d=f.length;c<d;c++)if(f[c].railWin&&(b=f[c].railWin.getWinById(a.id)))f[c].railWin.onchange(a)};this.setTitle=function(b){for(var c,d=0,e=f.length;d<e;d++)if(f[d].railWin){c=f[d].railWin.getWinById(b);var h=f[d].railWin.getFullTitle(b);if(h){a.changeTitle(h,f[d].getWindow(),c.appId);break}}};this.hasApp=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b].railWin.hasApp(a))return!0;return!1};this.delSurface=function(b){!b||b.railWin&&b.railWin.isRunning()||(svGlobal.logger.info("delete surface..."),
f.removeElm(b),b.close(),0==f.length&&a._unload())};this.getOwnerSurface=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b].railWin&&f[b].railWin.hasWin(a))return f[b];return null};this.getOwnerSurfaceById=function(a){for(var b,c=0,d=f.length;c<d;c++)if(f[c].railWin&&(b=f[c].railWin.getWinById(a)))return f[c];return null};this.getFocused=function(){for(var a=f.length,b=0;b<a;b++)if(f[b].focused)return f[b];return f[a-1]};this.close=function(){for(var a=0,b=f.length;a<b;a++)f[a]&&(f[a].remoteApp&&
f[a].remoteApp.close(),f[a].close(),f[a]=null)};this.LocalWin=function(b){function c(){a.writeRawInput("8C0"+b)}this.id=b;this.appId="";var d=this;this.resizable=function(){return d.isVisible?0!=(d.style&262144)||0!=(d.style&65536)||0!=(d.style&16777216)||3==d.showState:!1};this.setShowState=function(a){d.showState=a};this.parent=function(){return t.getWinById(d.ownerWinid)};this.resize=function(b,c,e,f){hi5.appcfg.disableJoinedAppResize&&2==a.mode||a.writeRawInput("8C1"+d.id+"\t"+b+"\t"+c+"\t"+e+
"\t"+f)};this.exeCommand=function(c){a.writeRawInput("8C4"+b+"\t"+c)};this.activate=function(c){2==d.showState?(d.exeCommand(61728),setTimeout(function(){a.writeRawInput("8C3"+b+"\t"+c)},50)):a.writeRawInput("8C3"+b+"\t"+c)};this.close=function(){d.exeCommand(61536)};this.getAppId=c;this.isVisible=function(){return d.winWidth&&d.winHeight&&d.showState&&45<d.winHeight&&45<d.winWidth};this.isMainWin=function(){if(!(d.isVisible()&&d.winWidth&&d.winHeight&&45<d.winHeight&&45<d.winWidth))return!1;var a=
1>d.ownerWinid;if(!a)return a;var b=d.style;if(0!=(b&4194304))return!0;if(0!=(b&2147483648)&&(0==(b&8388608)||0==(b&12582912)))return!1;var c=0!=(d.extStyle&128);(a=a&&!c)&&0!=(b&2147483648)&&0==(b&2156396544)&&(a=!1);return a};c()}}(d,x);this.getSurfaces=function(){return t};this.hide=function(){t&&t.hide()};this.getFileUrl=function(a){return d.modifyURL(ba()+"/DOWNLOAD?s="+xb+"&f="+a)};this.listFiles=function(a,b){J&&Y&&J.list(a,b)};this.writeRawInput=function(a){if(Y){A(a);if(d.onactivity)d.onactivity(a);
return!0}return!1};this.authWithCode=function(a,b){var c=a.length,d=new Uint8Array(5+c);d[0]=146;d[1]=7;d[2]=b;d[3]=c&255;d[4]=c>>8&255;for(var e=0;e<c;e++)d[5+e]=a.charCodeAt(e);A(d.buffer)};var R=new function(a,b,c,f){this.setJoinMode=a.setJoinMode;this.requestControl=a.requestControl;this.writeKeyComb=a.writeKeyComb;this.writeText=a.writeText;this.localLockFlags=f||0;this.remoteLockFlags=0;this.checkLockFlags=!0;this.reqCopyTime=0;this.draw=c.draw;var e=a.isRemoteApp(),q=a.reconnectOnResize;this.saveResize=
function(b){q=a.reconnectOnResize;a.reconnectOnResize=b};this.restoreResize=function(){a.reconnectOnResize=q};this.refresh=function(a,b,d,e){return c.repaint(a,b,d-a+1,e-b+1)};this.getAppMode=function(){return a.mode};this.send=a.writeRawInput;this.saveSession=function(b){a.saveSession(b)};this.sendInput=a.writeRawInput;this.getAppInfo=function(){return a.sessionInfo.appInfo};this.resumeAudio=function(){L.supportWebAudio&&L.iOSFix()};this.onresize=function(b){if(b=b.target.svSurface){var c=b.getFreeSpace();
b=c.width;c=c.height;R.checkLockFlags=!0;a.resetSize(b,c)}};this.onorientationchange=function(b){a.resetSize(b.innerWidth,b.innerHeight)};this.getClipData=function(b,c){this.reqCopyTime=Date.now();var d=hi5.httpGet(a.modifyURL(a.getGatewayAddr()+"/CLIP?s="+a.sessionInfo.appInfo.session+"&t="+Date.now()+"&type="+b),c);this.reqCopyTime=Date.now();yb(d);return d};this.onfocus=function(b){var d=t.getFocused();e&&d&&d.railWin&&(b=d.railWin.mainWin)&&a.running()&&(d=d.context)&&d!=c.getContext()&&(c.setContext(null),
b.activate(1),svGlobal.logger.info("Activate win:"+b.id))};this.getShareFiles=a.listFiles;this.getFile=function(b){a.reconnectOnResize=!1;var c=a.getFileUrl(b);d.ondownload&&d.ondownload({fileName:b,url:c})||window.open(c)};this.getFileLink=a.getFileUrl;this.getGateway=function(){return k};this.reconnect=function(b,c,d){h.symlink?(b="user="+b+"&pwd="+c,d&&(b+="&domain="+d),k=hi5.tool.replaceQuery(k,"parameters",b)):(k=hi5.tool.replaceQuery(k,"user",b),k=hi5.tool.replaceQuery(k,"pwd",c),k=hi5.tool.replaceQuery(k,
"domain",d));a.run()};this.sendKeyboardSyncFlags=function(b){return a.writeRawInput("8E5"+b)?(this.remoteLockFlags=this.localLockFlags=b,!0):!1};this.sendKeyboardSynchronize=function(a,b,c){var d=0;c&&(d|=4);b&&(d|=2);a&&(d|=1);this.sendKeyboardSyncFlags(d)};this.fromSyncedSurface=function(a){return b.fromSyncedSurface(a)};this.setWorkDir=function(b){a.writeKeyComb("Windows+R",20,function(){setTimeout(function(){a.writeText(b,10,function(){a.writeScancode(!0,28);a.writeScancode(!1,28)})},666)})};
this.authWithCode=function(b,c){a.authWithCode(b,c)}}(d,t,x,h.numLock?2:0);this.sendKeyboardSynchronize=function(a,b,c){R.sendKeyboardSynchronize(a,b,c)};var O=null,G={count:0,names:[],close:function(){for(var a=G.names,b=0,c=a.length;b<c;b++)G[a[b]].onclose&&(G[a[b]].onclose(),G[a[b]]=null);a.length=0},init:function(a,b,c,f,e){function h(){this.WAVE_FORMAT_PCM=1;this.WAVE_FORMAT_ADPCM=2;this.WAVE_FORMAT_ALAW=6;this.WAVE_FORMAT_MULAW=7;this.WAVE_FORMAT_GSM=49;this.WAVE_FORMAT_MPEGLAYER3=85;this.WAVE_FORMAT_AAC=
41222;this.bitsPerSample=this.nBlockAlign=this.nAvgBytesPerSec=this.nSamplesPerSec=this.nChannels=this.formatTag=0;this.hasLocalSupport=!1;this.cbSize=0;this.extenstion=null;var a=this;this.fromBuffer=function(b){a.formatTag=b.getLittleEndian16();a.nChannels=b.getLittleEndian16();a.nSamplesPerSec=b.getLittleEndian32();a.nAvgBytesPerSec=b.getLittleEndian32();a.nBlockAlign=b.getLittleEndian16();a.bitsPerSample=b.getLittleEndian16();var c=b.getLittleEndian16();a.cbSize=c;0<c&&(a.extenstion=Array(c),
b.copyToByteArray(a.extenstion,0,b.getPosition(),c),b.skipPosition(c))};this.toBuffer=function(b){b.setLittleEndian16(a.formatTag);b.setLittleEndian16(a.nChannels);b.setLittleEndian32(a.nSamplesPerSec);b.setLittleEndian32(a.nAvgBytesPerSec);b.setLittleEndian16(a.nBlockAlign);b.setLittleEndian16(a.bitsPerSample);b.setLittleEndian16(a.cbSize);0<a.cbSize&&b.setBytes(a.extenstion)};this.getSize=function(){return 18+a.cbSize};this.toString=function(){return"Audio Format, tag="+a.formatTag+" nChannels="+
a.nChannels+" nSamplesPerSec="+a.nSamplesPerSec+" nAvgBytesPerSec"+a.nAvgBytesPerSec+" nBlockAlign"+a.nBlockAlign+" bitsPerSample"+a.bitsPerSample+" cbSize="+a.cbSize}}function g(){O=new d.DynamicChannel;O.name="Microsoft::Windows::RDS::DisplayControl";O.enabled=!1;O.process=function(a){var b=a.getLittleEndian32();a.getLittleEndian32();switch(b){case 5:b=a.getLittleEndian32(),O.maxMonitorAreaFactorA=a.getLittleEndian32(),O.maxMonitorAreaFactorB=a.getLittleEndian32(),O.enabled=!0,svGlobal.logger.warn("Display control maxNumMonitors:"+
b+" factorA:"+O.maxMonitorAreaFactorA+" factorB:"+O.maxMonitorAreaFactorB),a=new Uint8Array(2),a[0]=146,a[1]=4,A(a.buffer),N&&setTimeout(function(){N&&N.check(5E3)},1900)}};O.applyResolution=function(a,b){if(O.enabled){var c=new Uint8Array(56),d=new RdpBuffer(c,0,56);a=a>O.maxMonitorAreaFactorA?O.maxMonitorAreaFactorA:a&-4;b=b>O.maxMonitorAreaFactorB?O.maxMonitorAreaFactorB:b&-4;d.setLittleEndian32(2);d.setLittleEndian32(56);d.setLittleEndian32(40);d.setLittleEndian32(1);d.setLittleEndian32(1);d.setLittleEndian32(0);
d.setLittleEndian32(0);d.setLittleEndian32(a);d.setLittleEndian32(b);d.setLittleEndian32(.26458*a|0);d.setLittleEndian32(.26458*b|0);d.setLittleEndian32(a>b?0:90);d.setLittleEndian32(100);d.setLittleEndian32(100);O.send(c);svGlobal.logger.warn("Display control: "+a+"x"+b)}else svGlobal.logger.warn("Display control disabled.")};return O}if(!r.disableDVC){if(r.enableEcho){var k=new d.DynamicChannel;k.name="ECHO";k.process=function(a){var b=a.getPosition(),c=a.getEnd(),d=new Uint8Array(c-b);d.set(a.getData().subarray(b,
c));k.send(d)};d.addDynamicChannel(k)}if(a){var C=new d.DynamicChannel;C.name="Microsoft::Windows::RDS::Input";C.process=function(a){var b=a.getLittleEndian16();a.getLittleEndian32();switch(b){case 1:a.skipPosition(4),a=new RdpBuffer(new Uint8Array(16),0,16),a.setLittleEndian16(2),a.setLittleEndian32(16),a.setLittleEndian32(3),a.setLittleEndian32(65536),a.setLittleEndian16(256),a.markEnd(),C.send(a);case 5:t.execute("setTouchRemoting",[!0]);G.isTouchReady=!0;svGlobal.logger.info("Touch remoting start");
break;case 4:t.execute("setTouchRemoting",[!1]),G.isTouchReady=!1,svGlobal.logger.info("Touch remoting suspend")}};d.addDynamicChannel(C)}if(c){svGlobal.logger.warn("Audio input on");var B=new d.DynamicChannel;(function(){function a(a){var b=new RdpBuffer(new Uint8Array(5),0,5);b.setByte(7);b.setLittleEndian32(a);b.markEnd();B.send(b)}function b(b){b.getLittleEndian32();var n=b.getLittleEndian32();(new h).fromBuffer(b);f=!0;g=d.reconnectOnResize;d.reconnectOnResize=!1;r.onopen||(r.onopen=function(b){if(F){c=
b;d.reconnectOnResize=g;a(n);var e=new RdpBuffer(new Uint8Array(5),0,5);e.setByte(4);e.setLittleEndian32(b?0:1);e.markEnd();B.send(e)}});r.ondata||(r.ondata=function(a,b){c&&(k.length!=b+1&&(k=new Uint8Array(b+1),k[0]=6),B.send(e),k.set(a,1),B.send(k))});r.start()}B.name="AUDIO_INPUT";B.process=function(c){var d=c.getByte();switch(d){case 1:var g=c.getLittleEndian32(),d=new RdpBuffer(new Uint8Array(5),0,5);d.setByte(1);d.setLittleEndian32(g);d.markEnd();B.send(d);break;case 2:var n=c.getLittleEndian32();
c.getLittleEndian32();for(var d=[],l=[],k=L.getContext().sampleRate,g=0;g<n;g++){var m=new h;m.fromBuffer(c);49==m.formatTag&&22050==m.nSamplesPerSec?(m.hasLocalSupport=!0,d.push(m)):1==m.formatTag&&m.nSamplesPerSec==k&&2==m.nChannels&&l.push(m)}B.send(e);n=0;c=d.length;0==c&&(d=l,c=l.length,r.directInput=!0);for(g=0;g<c;g++)n+=d[g].getSize();l=new RdpBuffer(new Uint8Array(1024),0,1024);l.setByte(2);l.setLittleEndian32(c);l.setLittleEndian32(n+9);for(g=0;g<c;g++)d[g].toBuffer(l);l.skipPosition(1024-
n-9);l.markEnd();B.send(l);break;case 3:b(c);break;case 7:d=c.getLittleEndian32();f||(a(d),f=!1);break;default:svGlobal.logger.warn("audioInpt: invalid tag:"+d)}};var c=!1;B.onclose=function(){c=!1;r&&r.close()};var e=new Uint8Array(1);e[0]=5;var f=!1,g=d.reconnectOnResize,k=new Uint8Array(0),q=null,r=new function(a){function b(b){k=!0;if(l.onopen)l.onopen(!0);q=new MSGSMEncoder;f=b;g=a.createMediaStreamSource(b);b=l.directInput?1024:4096;n=a.createJavaScriptNode?a.createJavaScriptNode(b,1,1):a.createScriptProcessor(b,
1,1);l.directInput&&!u&&(u=new Int16Array(2048));n.onaudioprocess=function(a){if(e){a=a.inputBuffer.getChannelData(0);if(l.directInput){for(var b=0,c,d=0;1024>d;d++)c=32767*a[d],u[b++]=c,u[b++]=c;r.ondata(new Uint8Array(u.buffer),4196)}else t.addData(a,h);a.fill(0)}};g.connect(n);n.connect(a.destination)}function c(a){e=k=!1;if(l.onopen)l.onopen(!1);svGlobal.logger.warn("Error on getUserMedia: "+a)}function d(){e||(f&&f.getTracks&&f.getTracks()[0].stop(),n&&n.disconnect(),g&&g.disconnect(),k=!1)}
var e=!1,f=null,g=null,n=null,l=this,h=a.sampleRate/22050,k=!1,m=0;this.directInput=!1;var l=this,u;this.start=function(){m&&clearTimeout(m);if(!k)navigator.getUserMedia?navigator.getUserMedia({audio:!0},b,c):navigator.mediaDevices.getUserMedia({audio:!0}).then(b)["catch"](c);else if(l.onopen)l.onopen(!0);e=!0};this.stop=function(){e=!1};this.close=function(){e=!1;t&&t.reset();q=new MSGSMEncoder;m=setTimeout(d,3E5)};var t=new function(){function a(a){for(var n=d/160|0,h=0;h<n;h++){var k=q.encode(a,
c,g,e);e+=k;e==f&&(e=0,l.ondata(g,f));c+=160;d-=160}b=0<d?a:null}var b=null,c=0,d=0,e=0,f=65*Math.floor(Math.floor(Math.floor(4096/h)/160)/2),g=new Uint8Array(f);this.reset=function(){d=c=e=0;b=null};this.addData=function(e,f){var g=e;if(1==f)e=g;else if(1>f)console.error("rate must be smaller than the original rate"),e=void 0;else{for(var n=new Float32Array(Math.round(g.length/f)),l=0,h=0;l<n.length;){for(var k=Math.round((l+1)*f),m=0,p=0;h<k&&h<g.length;h++)m+=g[h],p++;n[l]=m/p;l++;h=k}e=n}0==d?
(d=e.length,c=0,a(e)):(g=e,n=d+g.length,l=new Float32Array(n),l.set(b.subarray(c)),l.set(g,d),c=0,d=n,a(l))}}}(L.getContext())})();d.addDynamicChannel(B)}d.addDynamicChannel(function(){var a=new d.DynamicChannel;a.name="TSMF";var b={type:"image/jpeg"},c=Array(1);a.process=function(d){d.getPosition();var e=d.getLittleEndian32()&1073741823;var f=d.getLittleEndian32();var g=d.getLittleEndian32();switch(e){case 2:if(256==g){d.getLittleEndian32();g=new Uint8Array(16);var l=new RdpBuffer(g,0,16);l.setLittleEndian32(2);
l.setLittleEndian32(f);l.setLittleEndian32(1);l.setLittleEndian32(0);a.send(g)}break;case 0:switch(g){case 257:d.getBytes(16);d.getLittleEndian32();break;case 256:e=d.getPosition();l=d.getLittleEndian32();for(g=0;g<l;g++){d.getLittleEndian32();var h=d.getLittleEndian32();d.getLittleEndian32();d.skipPosition(h-4)}g=d.getPosition()-e;l=g+8+4;g=new Uint8Array(l);l=new RdpBuffer(g,0,l);l.setLittleEndian32(-2147483648);l.setLittleEndian32(f);g.set(d.getData().subarray(e,d.getPosition()),8);a.send(g);break;
case 261:d.getBytes(16);d.getLittleEndian32();break;case 264:e=d.getLittleEndian32();d.skipPosition(4);d.getLittleEndian32();h=d.getBytes(16);var n=d.getBytes(16);d.getLittleEndian32();d.getLittleEndian32();d.getLittleEndian32();var k=d.getBytes(16);g=d.getLittleEndian32();d.skipPosition(g);g=new Uint8Array(20);l=new RdpBuffer(g,0,20);l.setLittleEndian32(-2147483648);l.setLittleEndian32(f);hi5.Arrays.equals([118,105,100,115,0,0,16,0,128,0,0,170,0,56,155,113],h)&&hi5.Arrays.equals([77,74,80,71,0,0,
16,0,128,0,0,170,0,56,155,113],n)&&hi5.Arrays.equals([128,159,88,5,86,195,206,17,191,1,0,170,0,85,89,90],k)?l.setLittleEndian32(1):(l.setLittleEndian32(0),svGlobal.logger.warn("Format is not supported:"),svGlobal.logger.warn(h),svGlobal.logger.warn(n),svGlobal.logger.warn(k));l.setLittleEndian32(e);a.send(g);break;case 258:d.getBytes(16);d.getLittleEndian32();e=d.getLittleEndian32();d.skipPosition(e);break;case 263:d.getBytes(16),g=new Uint8Array(16),l=new RdpBuffer(g,0,16),l.setLittleEndian32(-2147483648),
l.setLittleEndian32(f),l.setLittleEndian32(1),a.send(g);case 277:d.getBytes(16);d.getLittleEndian32();break;case 262:d.getBytes(16);x.flushImgs();x.setImgRect(0,0,0,0);g=new Uint8Array(12);l=new RdpBuffer(g,0,12);l.setLittleEndian32(-2147483648);l.setLittleEndian32(f);a.send(g);break;case 278:d.getBytes(16);f=d.getLittleEndian32();g=d.getLittleEndian32();e=d.getLittleEndian32();d=d.getLittleEndian32();x.setImgRect(f,g,e-f,d-g);break;case 265:d.getBytes(16);d.getLittleEndian64();d.getLittleEndian32();
break;case 266:d.getBytes(16);break;case 268:d.getBytes(16);break;case 267:d.getBytes(16);break;case 269:d.getBytes(16);d.getLittleEndian32();break;case 274:break;case 275:break;case 259:d.getBytes(16);d.getLittleEndian32();d.getLittleEndian32();d.skipPosition(32);g=d.getLittleEndian32();f=new Image;e=d.getPosition();c[0]=d.getData().subarray(e,e+g);d=new Blob(c,b);f.src=URL.createObjectURL(d);x.addImg(f);break;case 270:x.flushImgs();break;case 273:break;case 260:break;case 276:d.getBytes(16);g=d.getLittleEndian32();
e=d.getPosition()+g;d.skipPosition(8);f=d.getLittleEndian32();svGlobal.logger.info("window state:"+f);l=d.getLittleEndian32();h=d.getLittleEndian32();f=d.getLittleEndian32();g=d.getLittleEndian32();d.skipPosition(8);n=d.getLittleEndian32();k=d.getLittleEndian32();svGlobal.logger.info("Window rect, left:"+f+" top:"+g+" w:"+l+" h:"+h+" cl:"+n+" ct:"+k);d.setPosition(e);e=d.getLittleEndian32();for(e=d.getPosition()+e;d.getPosition()<e;){n=d.getLittleEndian32();k=d.getLittleEndian32();var m=d.getLittleEndian32(),
q=d.getLittleEndian32();svGlobal.logger.info("visible region, l:"+k+" t:"+n+" r:"+q+" b:"+m)}x.setImgRect(f,g,l,h);break;case 1:case 2:break;default:svGlobal.logger.warn("unknown function:"+g)}break;default:svGlobal.logger.warn("unkown interface:"+e)}};return a}());ma||d.addDynamicChannel(g());r.enableDVCAudio&&d.addDynamicChannel(function(a){var b=!1,c=0,e=0,f=0,g=0,k=[],m=new Uint8Array(4),q=new d.DynamicChannel;q.name="AUDIO_PLAYBACK_DVC";q.onclose=function(){};q.process=function(d){function l(b){b.skipPosition(14);
var c=b.getLittleEndian16();b.getByte();var d=b.getLittleEndian16();b.skipPosition(1);for(var e,f=k.length=0;f<c;f++){var g=new h;g.fromBuffer(b);(e=22050<=g.nSamplesPerSec&&(1==g.formatTag||49==g.formatTag&&22050==g.nSamplesPerSec&&0==a))&&k.push(g)}g=20;b=k.length;for(f=0;f<b;f++)g+=k[f].getSize();f=g+4;c=new RdpBuffer(new Uint8Array(f),0,f);c.setByte(7);c.setByte(2);c.setLittleEndian16(g);c.setLittleEndian32(3);c.setLittleEndian32(4294967295);c.setLittleEndian32(0);c.setLittleEndian16(0);c.setLittleEndian16(b);
c.skipPosition(1);c.setLittleEndian16(d);c.setByte(124);for(f=0;f<b;f++)g=k[f],g.toBuffer(c);c.markEnd();q.send(c);5<d&&(c=new RdpBuffer(new Uint8Array(8),0,8),c.setByte(12),c.skipPosition(1),c.setLittleEndian16(4),c.setLittleEndian16(0),c.setLittleEndian16(0),c.markEnd(),q.send(c))}function n(a){var b=a.getLittleEndian16();a=a.getLittleEndian16();var c=new RdpBuffer(new Uint8Array(8),0,8);c.setByte(6);c.setByte(35);c.setLittleEndian16(4);c.setLittleEndian16(b);c.setLittleEndian16(a);c.markEnd();
q.send(c)}function u(){var a=k[f];if(a.formatTag!=S||a.nSamplesPerSec!=ga||W!=a.nChannels)S=a.formatTag,W=a.nChannels,ga=a.nSamplesPerSec,la=49==a.formatTag?8:a.bitsPerSample}function r(a){e=a.getLittleEndian16();f=a.getLittleEndian16();g=a.getByte();a.skipPosition(3);m[0]=a.getByte();m[1]=a.getByte();m[2]=a.getByte();m[3]=a.getByte();b=!0;u()}function t(a,b){var c=new RdpBuffer(new Uint8Array(8),0,8);c.setByte(5);c.skipPosition(1);c.setLittleEndian16(4);c.setLittleEndian16(a);c.setByte(b);c.skipPosition(1);
c.markEnd();q.send(c)}function P(a){b=!1;var d=c-8,f=Date.now();a.copyFromByteArray(m,0,a.getPosition(),4);a=bb(a,g,e,d);a=1E3*(a-L.delay);f=e+(Date.now()-f)+a;t(f,g)}function x(a){var b=Date.now();e=a.getLittleEndian16();f=a.getLittleEndian16();g=a.getByte();a.skipPosition(7);u();a=bb(a,g,e,0);a=1E3*(a-L.delay);b=e+(Date.now()-b)+a;t(b,g)}if(b)P(d);else{var y=d.getByte();d.skipPosition(1);c=d.getLittleEndian16();switch(y){case 7:l(d);break;case 6:n(d);break;case 2:r(d);break;case 1:closed=!0;break;
case 3:d.getLittleEndian16();d.getLittleEndian16();break;case 13:x(d)}}};return q}(f));var z={videoMedia:{video:null,track:null,canvas:null,ctx:null,resolutions:null,minFrameRate:16,type:2,activate:function(a,b){svGlobal.logger.info("activate webcam");z.videoMedia.resolutions?a():hi5.video.resolutions(function(c){c.length?(z.videoMedia.resolutions=c,a()):b()})},deactivate:function(){var a=z.videoMedia;a.track&&(a.track.stop(),a.track=null);a.ctx=null;a.canvas=null;a.video=null;svGlobal.logger.info("deactivate cam")},
startStream:function(a,b,c,d,e){svGlobal.logger.info("startStream, width:"+a+" height:"+b+" frameRate:"+c);var f=z.videoMedia,g=f.track;if(g){var l=g.getSettings();if("live"==g.readyState)if(a!=l.width||b!=l.height||c!=l.frameRate&&2!=f.type)g.stop();else return}navigator.mediaDevices.getUserMedia({video:{frameRate:2==f.type?f.minFrameRate:c,width:{exact:a},height:{exact:b}}}).then(function(a){var b=document.createElement("video");b.srcObject=a;b.play();if(window.OffscreenCanvas)var c=new OffscreenCanvas(100,
100);else c=document.createElement("canvas"),c.style.position="absolute",c.style.left=0,c.style.top=0;f.track=a.getVideoTracks()[0];f.canvas=c;f.ctx=c.getContext("2d");f.video=b;a=f.track.getSettings();f.canvas.width=a.width;f.canvas.height=a.height;d()})["catch"](function(a){svGlobal.logger.warn(a);e()})},stopStream:function(){svGlobal.logger.info("stopStream");var a=z.videoMedia;a.track&&"live"==a.track.readyState&&a.track.stop()},grabFrame:function(a){function b(b){b.arrayBuffer().then(a)}var c=
z.videoMedia;c.ctx.drawImage(c.video,0,0);c=c.canvas;c.convertToBlob?c.convertToBlob({type:"image/jpeg",quality:.6}).then(b):c.toBlob(b,"image/jpeg",.6)},propertyList:[[{propertyId:1,capabilities:3,min:4294967286,max:4294967294,step:1,"default":4294967291},null,{propertyId:3,capabilities:101,min:4294967280,max:16,step:1,"default":0},{propertyId:4,capabilities:1,min:0,max:3,step:1,"default":0},{propertyId:5,capabilities:1,min:4294967280,max:16,step:1,"default":0},{propertyId:6,capabilities:1,min:100,
max:400,step:10,"default":100}],[{propertyId:1,capabilities:1,min:0,max:2,step:1,"default":1},{propertyId:2,capabilities:199,min:4294967232,max:64,step:1,"default":0},{propertyId:3,capabilities:1,min:0,max:95,step:1,"default":0},{propertyId:4,capabilities:1,min:4294965296,max:2E3,step:1,"default":0},{propertyId:5,capabilities:67,min:2800,max:6500,step:1,"default":4600}]]},WEBCAM:function(a){var b=new a;b.name="RDCamera_Device_0";b.version=2;b.newInstance=function(){return z.WEBCAM(a)};b.onopen=function(){svGlobal.logger.info("cam open")};
b.onclose=function(){svGlobal.logger.info("cam close")};b.sendSucess=function(){var a=new hi5.DataBuffer(new Uint8Array(2));a.setByte(b.version);a.setByte(1);a.markEnd();b.send(a)};b.sendError=function(a){var c=new hi5.DataBuffer(new Uint8Array(6));c.setByte(b.version);c.setByte(2);c.setLittleEndian32(a||1);c.markEnd();b.send(c)};b.sendSteamListResp=function(){var a=new hi5.DataBuffer(new Uint8Array(7));a.setByte(b.version);a.setByte(10);a.setLittleEndian16(1);a.setByte(1);a.setByte(1);a.setByte(0);
a.markEnd();b.send(a)};b.sendMediaTypeListResp=function(a){var c=z.videoMedia.resolutions,d=c.length,e=new hi5.DataBuffer(new Uint8Array(2+26*d));e.setByte(b.version);e.setByte(12);for(var f=1==a,g=0;g<d;g++){e.setByte(a);var l=c[g];e.setLittleEndian32(l.width);e.setLittleEndian32(l.height);e.setLittleEndian32(f?l.frameRate:z.videoMedia.minFrameRate);e.setLittleEndian32(1);e.setLittleEndian32(1);e.setLittleEndian32(1);e.setByte(1)}e.markEnd();b.send(e)};b.sendCurrentMediaType=function(a,c){var d=
new hi5.DataBuffer(new Uint8Array(28));d.setByte(b.version);d.setByte(14);var e=z.videoMedia.resolutions[c];d.setByte(a);d.setLittleEndian32(e.width);d.setLittleEndian32(e.height);d.setLittleEndian32(1==a?e.frameRate:z.videoMedia.minFrameRate);d.setLittleEndian32(1);d.setLittleEndian32(1);d.setLittleEndian32(1);d.setByte(1);d.markEnd();b.send(d)};b.sendSampleResp=function(a){z.videoMedia.grabFrame(function(c){var d=new hi5.DataBuffer(new Uint8Array(c.byteLength+3));d.setByte(b.version);d.setByte(18);
d.setByte(a);d.setBytes(new Uint8Array(c));d.markEnd();b.send(d)})};b.sendPropertyListResp=function(){for(var a=0,c,d,e=z.videoMedia.propertyList,f=0;2>f;f++){d=e[f];c=d.length;for(var g=0;g<c;g++)null!=d[g]&&a++}a=new hi5.DataBuffer(new Uint8Array(2+19*a));a.setByte(b.version);a.setByte(21);for(f=0;2>f;f++)for(d=e[f],c=d.length,g=0;g<c;g++)null!=d[g]&&(a.setByte(f),a.setByte(d.propertyId),a.setByte(d.capabilities),a.setLittleEndian32(d.min),a.setLittleEndian32(d.max),a.setLittleEndian32(d.step),
a.setLittleEndian32(d["default"]));a.markEnd();b.send(a)};b.sendPropertyValueResp=function(a,c){var d=z.videoMedia.propertyList[a][c-1];if(d){var e=new hi5.DataBuffer(new Uint8Array(7));e.setByte(b.version);e.setByte(23);e.setByte(1);e.setLittleEndian32(d.value||d["default"]);e.markEnd();b.send(e)}else b.sendError(8)};b.process=function(a){a.getByte();var c=a.getByte();switch(c){case 7:z.videoMedia.activate(b.sendSucess,b.sendError);break;case 8:z.videoMedia.deactivate();b.sendSucess();break;case 9:b.sendSteamListResp();
break;case 11:a=a.getByte();0!=a&&svGlobal.logger.warn("Invalid stream index: "+a);b.sendMediaTypeListResp(z.videoMedia.type);break;case 13:a=a.getByte();b.sendCurrentMediaType(z.videoMedia.type,a);break;case 15:a.getByte();c=a.getByte();if(c!=z.videoMedia.type){svGlobal.warn("Invalid video format req:"+c);b.sendError(6);break}var c=a.getLittleEndian32(),d=a.getLittleEndian32();a=a.getLittleEndian32()/a.getLittleEndian32();z.videoMedia.startStream(c,d,a,b.sendSucess,b.sendError);break;case 16:z.videoMedia.stopStream();
b.sendSucess();break;case 17:a=a.getByte();0!=a&&svGlobal.log("Invalid stream index for SampleRequest: "+a);b.sendSampleResp(a);break;case 20:b.sendPropertyListResp();break;case 22:c=a.getByte();a=a.getByte();b.sendPropertyValueResp(c,a);break;case 24:b.sendError(10);break;default:b.sendError(10),svGlobal.logger.warn("Invalid cam msg: "+c)}};return b},WEBCAM_ENUM:function(a,b){var c=new a;c.name="RDCamera_Device_Enumerator";c.onopen=function(){var a=new hi5.DataBuffer(new Uint8Array(2));a.setByte(b.version);
a.setByte(3);a.markEnd();c.send(a);svGlobal.logger.info("camEnum open")};c.onclose=function(){svGlobal.logger.info("camEnum closed");z.videoMedia.deactivate()};c.addDevice=function(a){a+="\x00";var d=b.name+"\x00",e=new hi5.DataBuffer(new Uint8Array(2+2*a.length+d.length));e.setByte(b.version);e.setByte(5);e.setUnicodeString(a);e.setAscllString(d);e.markEnd();c.send(e)};c.process=function(a){var d=a.getByte();a=a.getByte();switch(a){case 4:svGlobal.logger.info("camEnum ver resp: "+d);b.version=d;
c.addDevice(hi5.video.webcam&&hi5.video.webcam.label||"Web Camera");break;default:svGlobal.logger.warn("invalid messageId on camEnum: "+a)}};return c}};e&&(a=z.WEBCAM(d.DynamicChannel),b=z.WEBCAM_ENUM(d.DynamicChannel,a),d.addDynamicChannel(b),d.addDynamicChannel(a))}}};this.resetStatus=Sa;this.exeAppCmd=function(a){var b=t.getFocused();b&&b.exeCommand(a)};this.activateApp=function(a){var b;(b=hi5.tool.isNumber(a)?t.getWinById(a):t.getMainWinByAppId(a))?b.activate(1):svGlobal.logger.warn("No window found in "+
a)};this.reconnect=function(a,b,c){void 0==c&&(c=r.forceReconnect||!1);if(!F&&!c)return!1;h.minWidth&&a<h.minWidth&&(a<h.minWidth&&svGlobal.logger.warn("Width "+a+" is samller than minWidth "+h.minWidth),a=h.minWidth);h.minHeight&&b<h.minHeight&&(b<h.minHeight&&svGlobal.logger.warn("Height "+b+" is samller than minHeight "+h.minHeight),b=h.minHeight);a&=-4;b&=-4;if(!c&&4>Math.abs(a-H)&&4>Math.abs(b-B))return!1;if(O&&O.enabled&&!1!==r.displayVC)O.applyResolution(a,b);else if(cb&&qa||c||Y&&!cb)qa=!1,
svGlobal.logger.info("reconnecting..."),A("8E0"+a+"\t"+b),R&&(R.remoteLockFlags=0,R.checkLockFlags=!0);return!0};this.notify=function(a,b){a="8E6"+a;b&&(a+="\t"+b.join(";"));A(a)};this.getUploadManager=function(){return J};this.addSurface=function(a){if(!t.hasSurface(a)&&(Ia||x.setContext(a.context),!t.hasSurface(a)||!a.railWin)){ma&&a.setPlayerMode();h.mouseMoveEmu&&(a.mouseMoveEmu=M(h.mouseMoveEmu));a.setSize(50,50,"hidden");var b=a.getFreeSpace();0==H&&(H=b.width);0==B&&(B=b.height);a.setConfig(r);
t.addSurface(a);pa(H,B,!0,h.monitorDef?!0:!1);a.setController(R);a.setTouchpad(M(h.touchpad));var c=b=M(h.mapClipboard),d=b;void 0!=h.copyToLocal?c=M(h.copyToLocal):void 0!=r.copyToLocal&&(c=r.copyToLocal);void 0!=h.copyToRemote?d=M(h.copyToRemote):void 0!=r.copyToRemote&&(d=r.copyToRemote);a.setClipboard(b,c,d);Ha&&Ta(a);h.invitation&&(t.setReadOnly(!0),b=hi5.$("requestControl"))&&(b.disabled=!1);b=void 0!=h.ctrlToWin?M(h.ctrlToWin):void 0!=r.ctrlToWin?r.ctrlToWin:!0;c=void 0!=h.cmdToCtrl?M(h.cmdToCtrl):
void 0!=r.cmdToCtrl?r.cmdToCtrl:!0;a.run(parseInt(h.keyboard||1033,10),b,!1,c)}};this.getRunninApps=this.getRunningApps=function(){for(var a=[],b=0,c=t.size();b<c;b++)t.getSurface(b).railWin.getMain(t.zOrders)&&a.push(t.getSurface(b).railWin.getMain(t.zOrders).titleInfo);return a};this.startApp=function(a,b,c){b=b||"";c=c||"";A("8C2"+a+"\t"+b+"\t"+c);var d=t.getSurface(t.size()-1);d&&(d.remoteApp=new gb(a,b,c))};this.startExitingApp=function(a){a=t.popWins(a);for(var b=a.length-1;0<=b;b--)t.addWin(a[b])};
this.VirtualChannel=function(){return new Ua(143)};this.GatewayChannel=function(){return new Ua(28)};this.DynamicChannel=function(){return new Ua(64)};this.addChannel=function(a){ja[a.name]=a};this.addGatewayChannel=function(a){ka[a.name]=a};this.addDynamicChannel=function(a){G.names.push(a.name);G[a.name]=a;G.count++};var ia=null;M(h.scanner)&&(ia=new d.DynamicChannel,ia.name="SCANNERDVC",ia.onopen=function(){console.log("==== scanner DVC onopen().")},ia.process=function(a){var b=a.getByte();console.log("==== scanner DVC process(), type="+
b);switch(b){case 0:var c=a.getByte(),f=a.getByte(),b=new Uint8Array(10);b[0]=4;b[1]=7;b[2]=c;b[3]=f;b.set(a.getBytes(2),4);b.set(a.getBytes(2),6);b.set(a.getBytes(2),8);if(d.onagentmessage)d.onagentmessage(b);break;case 1:break;case 2:c=a.getEnd()-a.getPosition();b=new Uint8Array(c+2);b[0]=4;b[1]=3;b.set(a.getBytes(c),2);if(d.onagentmessage)d.onagentmessage(b);break;case 3:c=a.getEnd()-a.getPosition();b=new Uint8Array(c+3);b[0]=4;b[1]=9;b[2]=0;b.set(a.getBytes(c),3);if(d.onagentmessage)d.onagentmessage(b);
break;default:console.log('Warning: Unknown type "'+b+'" received from DVC, ignored.')}},ia.onclose=function(){var a=new Uint8Array(2);a[0]=4;a[1]=4;if(d.onagentmessage)d.onagentmessage(a)},d.addDynamicChannel(ia));var oa=null;M(h.smartCard)&&(oa=new d.GatewayChannel,oa.name="SCARDSTB",oa.onopen=function(){var a=new Uint8Array(2);a[0]=3;a[1]=1;if(d.onagentmessage)d.onagentmessage(a)},oa.process=function(a){var b=a.getEnd()-a.getPosition(),c=new Uint8Array(b+2);c[0]=3;c[1]=3;c.set(a.getBytes(b),2);
if(d.onagentmessage)d.onagentmessage(c)},oa.onclose=function(){var a=new Uint8Array(2);a[0]=3;a[1]=4;if(d.onagentmessage)d.onagentmessage(a)},d.addGatewayChannel(oa));r.detectNetwork&&(k+="&connectType=7",Jb());this.getNetworkResult=function(){return Ea};this.writeAgent=function(a){a.byteLength&&(a=new Uint8Array(a));switch(a[0]){case 3:if(oa&&3==a[1]){var b=a.slice?new hi5.DataBuffer(a.slice(2,a.length)):new hi5.DataBuffer(a.subarray(2,a.length));oa.send(b)}break;case 4:if(ia)switch(a[1]){case 2:b=
a.slice?new hi5.DataBuffer(a.slice(2,a.length)):new hi5.DataBuffer(a.subarray(2,a.length));var c=document.getElementById("dsSelection");c||(c=document.createElement("div"),c.id="dsSelection",c.className="appdlg",document.body.appendChild(c));if(0!=b.getLittleEndian16())c&&(c.innerHTML="<p>Error on local: failed to get the list of connected scanners. Close to continue without scanning.</p>",c=new hi5.ui.Lightbox(c),c.onclose=function(){d.run()},c.show());else if(a=(a.byteLength-4)/41,0==a)c&&(c.innerHTML=
"<p>Error: Could not find any connected scanner. Please:<ul><li>Power on or connect the scanner and then refresh the page; or</li><li>Close this dialog to connect to the machine without using scanner.</li></ul></p>",c=new hi5.ui.Lightbox(c),c.onclose=function(){d.run()},c.show());else if(1==a){if(c=new Uint8Array(3),c[0]=4,c[1]=5,c[2]=0,d.onagentmessage)d.onagentmessage(c)}else if(c){c.innerHTML='<p> Please choose a scanner &lt;DriverType: DeviceName&gt; and click "Continue".</a></p>';for(var f=0;f<
a;f++){var e=b.getAscllString(41,!0),e=Kb(f,e);c.appendChild(e)}c.innerHTML+="<br>";c=new hi5.ui.LightboxWithBtn(c);c.onclose=function(){var a=0,b=document.querySelector('input[name="ds_name"]:checked');b&&(a=b.value);b=new Uint8Array(3);b[0]=4;b[1]=5;b[2]=a;if(d.onagentmessage)d.onagentmessage(b)};c.show()}break;case 3:case 8:case 10:b=a.slice?new hi5.DataBuffer(a.slice(2,a.length)):new hi5.DataBuffer(a.subarray(2,a.length));ia.send(b);break;case 4:b=a.slice?new hi5.DataBuffer(a.slice(2,a.length)):
new hi5.DataBuffer(a.subarray(2,a.length));ia.send(b);hi5.notifications.notify({msg:__svi18n.info.TwainNotSupported,type:2});break;case 6:b=a.slice?new hi5.DataBuffer(a.slice(2,a.length)):new hi5.DataBuffer(a.subarray(2,a.length));b.getLittleEndian16();d.run();break;default:svGlobal.logger.warn("Warning: Unknown response header: [4 / "+a[1]+"], ignored.")}break;default:svGlobal.logger.warn("Invalid channel data received: unknown type ["+a[0]+"].")}};var Xa={type:6,data:null};this.run=function(){ib();
L.supportWebAudio&&L.iOSFix()};this.getDesktop=function(){return x};this.mouseDown=function(a,b,c){Y&&A("80"+a+"\t"+b+"\t"+c)};this.mouseMove=function(a,b){Y&&A("82"+a+"\t"+b)};this.mouseUp=function(a,b,c){Y&&A("81"+a+"\t"+b+"\t"+c)};this.writeKeyCode=function(a,b){Y&&A("8B"+(a?0:49152)+"\t"+b)};this.writeScancode=function(a,b){Y&&("number"==typeof a?(A("840\t"+a),A("8449152\t"+a)):A("84"+(a?0:49152)+"\t"+b))};this.resetSize=function(a,b){U?(na&&(clearTimeout(na),na=0),O&&O.enabled&&O.applyResolution(a,
b),na=setTimeout(function(){d.writeRawInput("8C661441\t"+a+"\t"+b);Ab();svGlobal.logger.info("-- displayChange, h:"+b)},150)):d.reconnectOnResize&&d.running()&&(na&&(clearTimeout(na),na=0),na=setTimeout(function(){d.reconnect(a,b)},555))};var T=new RdpBuffer([],0,0);this.suppressOutput=function(a){if(!d.sessionInfo.suppressOutput)return!1;void 0==a&&(a=!0);var b=new Uint8Array(a?3:11);b[0]=146;b[1]=3;b[2]=a?1:0;a||(b[3]=Ma,b[4]=Ma>>8,b[5]=La,b[6]=La>>8,b[7]=Na,b[8]=Na>>8,b[9]=Oa,b[10]=Oa>>8);A(b.buffer);
return!0};this.refreshOutput=function(a,b,c,d){var e=new Uint8Array(c?11:3);e[0]=146;e[1]=3;e[2]=2;c&&(e[3]=a,e[4]=a>>8,e[5]=b,e[6]=b>>8,e[7]=c,e[8]=c>>8,e[9]=d,e[10]=d>>8);A(e.buffer)};this.sendPing=function(a){var b=new Uint8Array(a?2+a.length:2);b[0]=146;b[1]=0;a&&b.set(a,2);A(b.buffer)};this.startPing=function(a,b){b=b||0;N||(N=new hi5.tool.ResponseMonitor(function(){Y&&d.sendPing()},function(){if(Y&&d.onnoresponse)return d.onnoresponse()}));N.setInterval(a,b);var c=new Uint8Array(4);c[0]=146;
c[1]=2;c[2]=a;c[3]=b;A(c.buffer);setTimeout(function(){N&&N.check()},1E3*(a+b));I?I.postMessage({type:0,cmd:6,start:1}):(E.onSlowPath=E.onFastPath=pb,E.onReqHistory=function(){pb(15555)})};this.stopPing=function(){N&&N.stop();I?I.postMessage({type:0,cmd:6,start:0}):E.onSlowPath=E.onFastPath=E.onReqHistory=null};var aa=null,wb=0;this.play=function(){A("F3")};this.pause=function(){A("F2")};this.scan=function(a){A("F4"+(a?"1":"0"))};this.seek=function(a){var b=t.getFocused();b&&F&&(A("F4"+(a?"1":"0")+
"\t"+(a/b.getScale().x|0)),x.pause(!0))};var la=W=S=0;var ga=22050;var vb=!1;this.showMessage=function(a,b,c){d&&d.displayMsg&&a&&((b=b||t.getFocused())?b.showMessage(a,c):("string"==typeof a&&(a={msg:a,timeout:c||0}),hi5.notifications.notify(a)))};this._unload=wa;this.close=function(){svGlobal.logger.info("closing...");F&&U&&t&&r.closeRemoteApp&&t.tryCloseRemoteApps();x&&x.isSendingHistory()?(svGlobal.logger.warn("In the middle of sending history, close delayed"),setTimeout(zb,2222)):zb()};hi5.browser.isChromeApp?
chrome.runtime.onSuspend.addListener(d.close):window.addEventListener("unload",d.close,!1)}
Rdp.languageToKeyboard={af:0,sq:0,ar:1025,"ar-SA":1025,"ar-IQ":0,"ar-EG":0,"ar-LY":0,"ar-DZ":0,"ar-MA":0,"ar-TN":0,"ar-OM":0,"ar-YE":0,"ar-SY":0,"ar-JO":0,"ar-LB":0,"ar-KW":0,"ar-AE":0,"ar-BH":0,"ar-QA":0,eu:0,bg:0,be:0,ca:0,zh:2052,"zh-TW":1028,"zh-CN":2052,"zh-HK":1028,"zh-SG":2052,hr:0,cs:0,da:0,nl:1043,"nl-BE":2067,en:1033,"en-US":1033,"en-GB":2057,"en-AU":0,"en-CA":4105,"en-NA":0,"en-IE":0,"en-ZA":0,"en-JM":0,"en-BZ":0,et:0,fo:0,fa:0,fi:0,fr:1036,"fr-BE":2060,"fr-CA":3084,"fr-CH":4108,"fr-LU":0,
gd:0,"gd-IE":0,de:1031,"de-CH":2055,"de-AT":0,"de-LU":0,"de-LI":0,el:0,he:1037,hi:0,hu:0,is:1039,id:0,it:1040,"it-CH":66576,ja:3758162961,ko:3758162962,lv:0,lt:0,mk:0,mt:0,nb:1044,nn:1083,no:1044,pl:1045,pt:2070,"pt-BR":1046,rm:0,ro:0,"ro-MO":0,ru:1049,"ru-MO":0,sr:0,sk:0,sl:0,sb:0,es:1034,"es-AR":0,"es-GT":0,"es-CR":0,"es-PA":0,"es-DO":0,"es-MX":2058,"es-VE":0,"es-CO":0,"es-PE":0,"es-EC":0,"es-CL":0,"es-UY":0,"es-PY":0,"es-BO":0,"es-SV":0,"es-HN":0,"es-NI":0,"es-PR":0,sx:0,sv:1053,"sv-FI":0,th:0,
ts:0,tn:0,tr:1055,uk:0,ur:0,ve:0,vi:0,xh:0,ji:0,zu:0,detect:function(){var k=navigator&&(navigator.language||navigator.userLanguage||""),C=Rdp.languageToKeyboard[k];if(!C){var z=k.indexOf("-");z&&(C=Rdp.languageToKeyboard[k.substring(0,z)])}C||(console.log("No valid layout for "+k),C=1033);return C}};svGlobal.Rdp||(svGlobal.Rdp=Rdp);var RdpBuffer=hi5.DataBuffer;
